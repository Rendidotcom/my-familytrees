<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Kelola & Hapus Anggota</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  body {
    font-family: Arial, sans-serif;
    background: #f2f4f7;
    padding: 20px;
  }
  .card {
    max-width: 720px;
    margin: auto;
    background: #fff;
    padding: 20px;
    border-radius: 14px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.1);
  }
  h2 {
    text-align: center;
    margin-bottom: 15px;
  }
  .toolbar {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
  }
  .toolbar button {
    padding: 8px 14px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-size: 14px;
  }
  .danger {
    background: #d9534f;
    color: #fff;
  }
  .danger:disabled {
    opacity: .5;
    cursor: not-allowed;
  }
  .list {
    border-top: 1px solid #eee;
  }
  .row {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 4px;
    border-bottom: 1px solid #eee;
  }
  .row:hover {
    background: #fafafa;
  }
  .name {
    flex: 1;
    font-weight: bold;
  }
  .dom {
    color: #666;
    font-size: 14px;
  }
  .msg {
    margin-top: 12px;
    text-align: center;
    font-size: 14px;
  }
</style>
</head>

<body>

<div class="card">
  <h2>Kelola & Hapus Anggota</h2>

  <div class="toolbar">
    <label>
      <input type="checkbox" id="checkAll"> Pilih semua
    </label>
    <button id="btnDelete" class="danger" disabled>
      ðŸ—‘ Hapus Terpilih
    </button>
  </div>

  <div id="list" class="list"></div>

  <div id="msg" class="msg"></div>
</div>

<script type="module">
import "./config.js"; // API_URL + ADMIN_TOKEN

const listEl = document.getElementById("list");
const msgEl = document.getElementById("msg");
const btnDelete = document.getElementById("btnDelete");
const checkAll = document.getElementById("checkAll");

let members = [];

// ===============================
// LOAD SEMUA ANGGOTA
// ===============================
async function loadMembers() {
  msgEl.textContent = "Memuat data...";
  try {
    const res = await fetch(`${window.API_URL}?mode=getData`);
    const json = await res.json();

    if (json.status !== "success") {
      msgEl.textContent = "Gagal memuat data";
      return;
    }

    members = json.data || [];
    renderList();
    msgEl.textContent = `${members.length} anggota ditemukan`;

  } catch (e) {
    msgEl.textContent = "Error: " + e.message;
  }
}

// ===============================
// RENDER LIST
// ===============================
function renderList() {
  listEl.innerHTML = "";

  members.forEach(m => {
    const row = document.createElement("div");
    row.className = "row";

    row.innerHTML = `
      <input type="checkbox" class="chk" value="${m.id}">
      <div class="name">${m.name || "(tanpa nama)"}</div>
      <div class="dom">${m.domisili || "-"}</div>
    `;

    listEl.appendChild(row);
  });

  bindCheckbox();
}

// ===============================
// CHECKBOX LOGIC
// ===============================
function bindCheckbox() {
  const boxes = document.querySelectorAll(".chk");

  boxes.forEach(b => {
    b.addEventListener("change", updateButton);
  });

  checkAll.addEventListener("change", () => {
    boxes.forEach(b => b.checked = checkAll.checked);
    updateButton();
  });
}

function updateButton() {
  const checked = document.querySelectorAll(".chk:checked");
  btnDelete.disabled = checked.length === 0;
}

// ===============================
// DELETE TERPILIH
// ===============================
btnDelete.addEventListener("click", async () => {
  const checked = [...document.querySelectorAll(".chk:checked")];
  if (!checked.length) return;

  if (!confirm(`Yakin hapus ${checked.length} anggota?`)) return;

  btnDelete.disabled = true;
  msgEl.textContent = "Menghapus...";

  let success = 0;

  for (const c of checked) {
    try {
      const url =
        `${window.API_URL}?mode=delete&id=${c.value}&token=${window.ADMIN_TOKEN}`;
      const res = await fetch(url);
      const json = await res.json();
      if (json.status === "success") success++;
    } catch {}
  }

  msgEl.textContent = `âœ” ${success} anggota berhasil dihapus`;
  await loadMembers();
});

await loadMembers();
</script>

</body>
</html>
