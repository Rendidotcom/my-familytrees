<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Tambah Anggota</title>
<style>
body{font-family:Arial;background:#f4f7fa;margin:0;padding:0;display:flex;justify-content:center}
.container{background:#fff;padding:18px;margin-top:80px;border-radius:12px;width:92%;max-width:520px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
label{display:block;margin-top:10px;font-weight:600}
input,select,textarea{width:100%;padding:10px;margin-top:6px;border-radius:8px;border:1px solid #ccc}
button{margin-top:12px;padding:12px;border-radius:8px;border:0;background:#27ae60;color:#fff;cursor:pointer}
.nav{display:flex;gap:8px;position:fixed;top:0;width:100%;background:#3498db;padding:12px;color:white;justify-content:space-around}
.nav a{text-decoration:none;color:#fff;font-weight:bold}
.small{font-size:13px;color:#666;margin-top:6px;text-align:center}
</style>
</head>

<body>

<div class="nav">
  <a href="dashboard.html">üìã Dashboard</a>
  <a href="tree.html">üå≥ Tree</a>
  <a href="#" onclick="logout()">üö™ Logout</a>
</div>

<div class="container">
  <h3>‚ûï Tambah Anggota</h3>

  <form id="formAdd">
    
    <label>Nama</label>
    <input id="name" required>

    <label>Domisili</label>
    <input id="domisili" required>

    <label>Hubungan</label>
    <select id="relationship" required>
      <option value="">-- Pilih --</option>
      <option>Ayah</option>
      <option>Ibu</option>
      <option>Anak</option>
      <option>Saudara</option>
    </select>

    <label>Ayah</label>
    <select id="parentIdAyah"><option value="">-- Tidak ada --</option></select>

    <label>Ibu</label>
    <select id="parentIdIbu"><option value="">-- Tidak ada --</option></select>

    <label>Pasangan</label>
    <select id="spouseId"><option value="">-- Belum menikah --</option></select>

    <label>Urutan Anak</label>
    <input id="orderChild" type="number" min="1">

    <label>Status</label>
    <select id="status">
      <option value="">-- Pilih --</option>
      <option value="hidup">Masih Hidup</option>
      <option value="meninggal">Sudah Meninggal</option>
    </select>

    <label>Catatan</label>
    <textarea id="notes" rows="3"></textarea>

    <label>Foto (opsional)</label>
    <input type="file" id="photo" accept="image/*">

    <button type="submit">üíæ Simpan Anggota</button>
    <div id="msg" class="small"></div>

  </form>
</div>


<script>
const API_URL = "https://script.google.com/macros/s/AKfycby8WX2QXb_mc0lfP6AaAFqRNDIMyRkznr7o16zLU3BG9wV39uBG_qwDrxuIHOCbnrlBkw/exec";

// ===== üõ° CEK LOGIN + TOKEN VALID =====
const session = JSON.parse(localStorage.getItem("familyUser") || "null");
if(!session || !session.token){
  alert("‚ö† Harap login dahulu!");
  location.href="login.html";
}

// ---- Token Expired? ----
if(Date.now() > session.tokenExpire){
  alert("üîë Sesi login habis, silakan login ulang.");
  logout();
}

// ---- Hanya admin yang boleh tambah ----
if(session.role !== "admin"){
  alert("‚õî Akses ditolak! Hanya admin yang bisa menambah anggota.");
  location.href="dashboard.html";
}


// Convert file ke Base64
function toBase64(file){
  return new Promise((resolve,reject)=>{
    const reader=new FileReader();
    reader.onload=()=>resolve(reader.result);
    reader.onerror=reject;
    reader.readAsDataURL(file);
  });
}


// ==== Load dropdown anggota =====
async function loadMembers(){
  try{
    const res = await fetch(API_URL + `?mode=getData&token=${session.token}`);
    const j = await res.json();
    
    if(j.status !== "success"){
      alert("‚ö† Token tidak valid! Silakan login ulang.");
      logout();
      return;
    }

    const data = j.data;

    const ayah=document.getElementById("parentIdAyah");
    const ibu=document.getElementById("parentIdIbu");
    const spouse=document.getElementById("spouseId");

    data.forEach(m=>{
      const opt=`<option value="${m.id}">${m.name}</option>`;
      ayah.insertAdjacentHTML("beforeend",opt);
      ibu.insertAdjacentHTML("beforeend",opt);
      spouse.insertAdjacentHTML("beforeend",opt);
    });

  }catch(err){
    console.error(err);
  }
}


// == Save Data ==
document.getElementById("formAdd").addEventListener("submit", async e=>{
  e.preventDefault();
  const msg=document.getElementById("msg");
  msg.textContent="‚è≥ Menyimpan...";

  const file=document.getElementById("photo").files[0];
  let base64="";
  if(file) base64=(await toBase64(file)).split(",")[1];

  const payload={
    mode:"insert",
    token:session.token,
    createdBy:session.id,

    name:document.getElementById("name").value.trim(),
    domisili:document.getElementById("domisili").value.trim(),
    relationship:document.getElementById("relationship").value,
    parentIdAyah:document.getElementById("parentIdAyah").value,
    parentIdIbu:document.getElementById("parentIdIbu").value,
    spouseId:document.getElementById("spouseId").value,
    orderChild:document.getElementById("orderChild").value,
    status:document.getElementById("status").value,
    notes:document.getElementById("notes").value.trim(),
    photo_base64:base64,
    photo_type:file ? file.type : ""
  };

  const res = await fetch(API_URL,{
    method:"POST",
    body:JSON.stringify(payload)
  });

  const j=await res.json();

  if(j.status==="success"){
    msg.textContent="‚úî Anggota berhasil ditambahkan!";
    document.getElementById("formAdd").reset();
  } else {
    msg.textContent="‚ùå " + j.message;
  }
});


function logout(){
  localStorage.removeItem("familyUser");
  location.href="login.html";
}

loadMembers();
</script>
</body>
</html>
