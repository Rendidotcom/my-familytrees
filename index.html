<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Tambah Anggota Baru</title>
<link rel="stylesheet" href="style.css">

<style>
  body { background:#f2f5f9; font-family:system-ui; }
  .container {
    max-width: 720px;
    margin: 40px auto;
    background: #fff;
    padding: 28px;
    border-radius: 14px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.08);
  }
  h2 { text-align:center; margin-bottom:25px;color:#143F8C; }
  label { font-weight:600; margin-top:14px; display:block; }
  input, select, textarea {
    width:100%; padding:12px; margin-top:6px;
    border-radius:8px; border:1px solid #ccc;
  }
  button {
    width:100%; padding:14px;
    background:#143F8C; color:white; border:0;
    margin-top:20px; border-radius:8px;
    font-size:17px; cursor:pointer;
  }
  #preview { margin-top:10px; width:120px; display:none; border-radius:8px; }
  #msg { margin-top:20px; font-size:15px; }
</style>
</head>

<body>

<div class="container">
  <h2>➕ Tambah Anggota Keluarga</h2>

  <div id="msg"></div>

  <form id="formAdd">

    <label>Nama Lengkap</label>
    <input type="text" name="name" required>

    <label>Domisili</label>
    <input type="text" name="domisili">

    <label>Relationship</label>
    <input type="text" name="relationship" placeholder="Ayah / Ibu / Anak / dll">

    <label>Foto</label>
    <input type="file" id="photo" accept="image/*">
    <img id="preview">

    <label>Catatan</label>
    <textarea name="notes" rows="3"></textarea>

    <label>ID Ayah</label>
    <input type="text" name="parentIdAyah">

    <label>ID Ibu</label>
    <input type="text" name="parentIdIbu">

    <label>ID Pasangan</label>
    <input type="text" name="spouseId">

    <label>Urutan Anak</label>
    <input type="number" name="orderChild" min="1">

    <label>Role</label>
    <select name="role">
      <option value="user">User</option>
      <option value="admin">Admin</option>
    </select>

    <button type="submit">Simpan</button>

  </form>
</div>

<script src="config.js"></script>
<script src="auth.js"></script>

<script>
const API_URL = window.API_URL;
const msg = document.getElementById("msg");
const form = document.getElementById("formAdd");

document.getElementById("photo").onchange = e => {
  const f = e.target.files[0];
  if (!f) return;
  const img = document.getElementById("preview");
  img.src = URL.createObjectURL(f);
  img.style.display = "block";
};

/* ======================================================
   UPLOAD FOTO → SERVER GAS (Folder Drive)
====================================================== */
async function uploadPhoto(file) {
  const fd = new FormData();
  fd.append("mode", "uploadPhoto");
  fd.append("file", file);

  const res = await fetch(API_URL, { method: "POST", body: fd });
  return await res.json();  
}

/* ======================================================
   INSERT DATA KE SHEET1 SESUAI STRUKTUR APPENDROW
====================================================== */
async function saveMember(data) {
  const fd = new FormData();
  fd.append("mode", "insert");
  fd.append("json", JSON.stringify(data));
  fd.append("token", JSON.parse(localStorage.getItem("familyUser")).token);

  const res = await fetch(API_URL, { method:"POST", body:fd });
  return await res.json();
}

/* ======================================================
   SUBMIT FORM
====================================================== */
form.onsubmit = async (e) => {
  e.preventDefault();
  msg.innerHTML = "⏳ Mengirim data...";

  let photoURL = "";
  const file = document.getElementById("photo").files[0];

  // --- Upload foto jika ada ---
  if (file) {
    msg.innerHTML = "⏳ Upload foto...";
    const up = await uploadPhoto(file);

    if (up.status !== "success") {
      msg.innerHTML = `<span style="color:red">Gagal upload foto.</span>`;
      return;
    }
    photoURL = up.url;
  }

  // --- Kumpulkan data sesuai struktur GAS ---
  const data = {
    name: form.name.value,
    domisili: form.domisili.value,
    relationship: form.relationship.value,
    photoURL: photoURL,
    notes: form.notes.value,
    parentIdAyah: form.parentIdAyah.value,
    parentIdIbu: form.parentIdIbu.value,
    spouseId: form.spouseId.value,
    orderChild: form.orderChild.value,
    role: form.role.value,
    createdBy: JSON.parse(localStorage.familyUser).name || "unknown",
    status: "active"
  };

  msg.innerHTML = "⏳ Menyimpan ke Sheet1...";

  const j = await saveMember(data);

  if (j.status === "success") {
    msg.innerHTML = `<span style="color:green">✔ Data tersimpan. ID: ${j.id}</span>`;
    form.reset();
    document.getElementById("preview").style.display = "none";
  } else {
    msg.innerHTML = `<span style="color:red">❌ ${j.message}</span>`;
  }
};
</script>

</body>
</html>
