<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Tambah Anggota Keluarga</title>

<!-- Load GLOBAL API_URL -->
<script src="config.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f7fa;
  margin: 0;
  padding: 0;
  display: flex;
  justify-content: center;
}
.container {
  background: #fff;
  padding: 18px;
  margin-top: 80px;
  border-radius: 12px;
  width: 92%;
  max-width: 520px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.06);
}
label { display:block; margin-top:10px; font-weight:600; }
input, select, textarea {
  width:100%; padding:10px; margin-top:6px;
  border-radius:8px; border:1px solid #ccc; font-size:15px;
}
button {
  margin-top:12px; padding:12px; border-radius:8px; border:0;
  background:#27ae60; color:#fff; font-size:16px;
  width: 100%; cursor:pointer;
}
button:disabled { background:#9cccaf; }
.nav {
  display: flex; gap: 8px; position: fixed; top: 0;
  width: 100%; background: #3498db; padding: 12px;
  color: white; justify-content: space-around; font-weight: bold;
}
.nav a { text-decoration:none; color:#fff; }
.small { font-size:13px; color:#666; margin-top:6px; text-align:center; }
</style>
</head>

<body>

<div class="nav">
  <a href="dashboard.html">ðŸ“‹ Dashboard</a>
  <a href="tree.html">ðŸŒ³ Tree</a>
  <a href="#" onclick="logout()">ðŸšª Logout</a>
</div>

<div class="container">
  <h3>âž• Tambah Anggota</h3>

  <form id="formAdd">
    <label>Nama</label>
    <input id="name" required>

    <label>Domisili</label>
    <input id="domisili" required>

    <label>Hubungan</label>
    <select id="relationship" required>
      <option value="">-- Pilih --</option>
      <option>Ayah</option>
      <option>Ibu</option>
      <option>Anak</option>
      <option>Saudara</option>
    </select>

    <label>Ayah</label>
    <select id="parentIdAyah"><option value="">-- Tidak ada --</option></select>

    <label>Ibu</label>
    <select id="parentIdIbu"><option value="">-- Tidak ada --</option></select>

    <label>Pasangan</label>
    <select id="spouseId"><option value="">-- Belum menikah --</option></select>

    <label>Urutan Anak</label>
    <input id="orderChild" type="number" min="1">

    <label>Status</label>
    <select id="status">
      <option value="">-- Pilih --</option>
      <option value="hidup">Masih Hidup</option>
      <option value="meninggal">Sudah Meninggal</option>
    </select>

    <label>Catatan</label>
    <textarea id="notes" rows="3"></textarea>

    <label>Foto (opsional)</label>
    <input type="file" id="photo" accept="image/*">

    <button id="btnSave" type="submit">ðŸ’¾ Simpan Anggota</button>
    <div id="msg" class="small"></div>
  </form>
</div>

<script>
console.log("index.html loaded, API_URL =", window.API_URL);

// =======================
// VALIDASI LOGIN
// =======================
let session = JSON.parse(localStorage.getItem("familyUser") || "null");

if (!session || !session.token) {
  alert("âš  Harap login terlebih dahulu!");
  location.href = "login.html";
}

(async ()=>{
  try {
    const res = await fetch(`${API_URL}?mode=validate&token=${session.token}`);
    const j = await res.json();

    if (j.status !== "success") {
      alert("ðŸš« Sesi habis. Silakan login ulang.");
      logout();
    }
    session.role = j.role;
    session.name = j.name;

    if (session.role !== "admin") {
      alert("â›” Hanya admin yang bisa menambah anggota.");
      location.href = "dashboard.html";
    }
  } catch(e){
    console.error(e);
    alert("Gagal validasi. Coba lagi.");
  }
})();

// =======================
// Konversi file ke Base64
// =======================
function toBase64(file){
  return new Promise((resolve,reject)=>{
    const r = new FileReader();
    r.onload = ()=>resolve(r.result);
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

// =======================
// Load dropdown anggota
// =======================
async function loadMembers(){
  try {
    const res = await fetch(`${API_URL}?mode=getData`);
    const j = await res.json();

    if(j.status !== "success") return;

    const data = j.data;

    ["parentIdAyah","parentIdIbu","spouseId"].forEach(id=>{
      document.getElementById(id).innerHTML = `<option value="">-- Pilih --</option>`;
    });

    data.forEach(p=>{
      ["parentIdAyah","parentIdIbu","spouseId"].forEach(id=>{
        document.getElementById(id).insertAdjacentHTML(
          "beforeend",
          `<option value="${p.id}">${p.name}</option>`
        );
      });
    });

  } catch(err){
    console.error("Dropdown error:", err);
  }
}
loadMembers();

// =======================
// SIMPAN DATA ANGGOTA BARU
// =======================
document.getElementById("formAdd").addEventListener("submit", async e=>{
  e.preventDefault();

  const btn = document.getElementById("btnSave");
  const msg = document.getElementById("msg");

  btn.disabled = true;
  btn.textContent = "â³ Menyimpan...";
  msg.textContent = "";

  let base64 = "";
  const file = photo.files[0];
  if(file){
    const result = await toBase64(file);
    base64 = result.split(",")[1];
  }

  const payload = {
    mode: "insert",
    token: session.token,
    createdBy: session.name,
    name: name.value.trim(),
    domisili: domisili.value.trim(),
    relationship: relationship.value,
    parentIdAyah: parentIdAyah.value,
    parentIdIbu: parentIdIbu.value,
    spouseId: spouseId.value,
    orderChild: orderChild.value,
    status: status.value,
    notes: notes.value.trim(),
    photo_base64: base64,
    photo_type: file ? file.type : ""
  };

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });

    const j = await res.json();

    if(j.status === "success"){
      btn.textContent = "âœ” Tersimpan";
      msg.textContent = "Data berhasil ditambahkan.";
      formAdd.reset();
    } else {
      msg.textContent = "âŒ Gagal: "+j.message;
      btn.textContent = "ðŸ’¾ Simpan Anggota";
    }

  } catch(err){
    console.error(err);
    msg.textContent = "âŒ Error jaringan: "+err.message;
    btn.textContent = "ðŸ’¾ Simpan Anggota";
  }

  btn.disabled = false;
});

// =======================
// LOGOUT
// =======================
function logout(){
  fetch(`${API_URL}?mode=logout&token=${session.token}`)
    .finally(()=>{
      localStorage.removeItem("familyUser");
      location.href = "login.html";
    });
}
</script>

</body>
</html>
