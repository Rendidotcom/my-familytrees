<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>üå≥ Tambah Anggota Family Tree</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<script src="config.js"></script>
<script src="session.js"></script>

<style>
  body{background:#f4f7fa}
  .card{max-width:900px;margin:auto}
  .preview{max-width:140px;display:none}
</style>
</head>

<body>

<nav class="navbar navbar-dark bg-primary">
  <div class="container-fluid">
    <span class="navbar-brand">üå≥ Tambah Anggota</span>
    <div class="d-flex gap-2">
      <a href="dashboard.html" class="btn btn-light">Dashboard</a>
      <button id="btnLogout" class="btn btn-warning">Logout</button>
    </div>
  </div>
</nav>

<div class="container py-4">
  <div class="card shadow p-4">
    <h4 class="mb-3">Data Anggota Baru</h4>

    <form id="insertForm">

      <div class="mb-3">
        <label>Nama Lengkap</label>
        <input id="name" class="form-control" required>
      </div>

      <div class="mb-3">
        <label>Domisili</label>
        <input id="domisili" class="form-control">
      </div>

      <div class="mb-3">
        <label>Hubungan / Relationship</label>
        <input id="relationship" class="form-control">
      </div>

      <div class="row">
        <div class="col-md-4 mb-3">
          <label>Ayah</label>
          <select id="parentIdAyah" class="form-control"></select>
        </div>
        <div class="col-md-4 mb-3">
          <label>Ibu</label>
          <select id="parentIdIbu" class="form-control"></select>
        </div>
        <div class="col-md-4 mb-3">
          <label>Pasangan</label>
          <select id="spouseId" class="form-control"></select>
        </div>
      </div>

      <div class="mb-3">
        <label>Urutan Anak</label>
        <input id="orderChild" type="number" class="form-control">
      </div>

      <div class="mb-3">
        <label>Status</label>
        <select id="status" class="form-control">
          <option value="active">Active</option>
          <option value="deleted">Deleted</option>
        </select>
      </div>

      <div class="mb-3">
        <label>Catatan</label>
        <textarea id="notes" class="form-control"></textarea>
      </div>

      <div class="mb-3">
        <label>Foto (opsional)</label>
        <input id="photo" type="file" accept="image/*" class="form-control">
        <img id="preview" class="img-thumbnail mt-2 preview">
      </div>

      <button class="btn btn-success">üöÄ Simpan Anggota</button>

      <div id="msg" class="mt-3 text-muted small"></div>
    </form>
  </div>
</div>

<script>
const API_URL = window.API_URL;
const msg = document.getElementById("msg");

/* =========================
   SESSION & PROTECTION
========================= */
function getSession(){
  return JSON.parse(localStorage.getItem("familyUser") || "null");
}

function logout(){
  localStorage.removeItem("familyUser");
  location.href = "login.html";
}

document.getElementById("btnLogout").onclick = logout;

const session = getSession();
if(!session || !session.token){
  location.href = "login.html";
}

/* =========================
   LOAD MEMBER OPTIONS
========================= */
async function loadMembers(){
  const res = await fetch(`${API_URL}?mode=getData&ts=${Date.now()}`);
  const j = await res.json();
  if(j.status !== "success") return;

  fillSelect(parentIdAyah, j.data);
  fillSelect(parentIdIbu, j.data);
  fillSelect(spouseId, j.data);
}

function fillSelect(el, data){
  el.innerHTML = `<option value="">(Tidak ada)</option>`;
  data.forEach(m=>{
    el.insertAdjacentHTML("beforeend",
      `<option value="${m.id}">${m.name}</option>`);
  });
}

/* =========================
   PHOTO PREVIEW + BASE64
========================= */
function toBase64(file){
  return new Promise((resolve,reject)=>{
    const r = new FileReader();
    r.onload = ()=>resolve(r.result.split(",")[1]);
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

photo.onchange = ()=>{
  const f = photo.files[0];
  if(f){
    preview.src = URL.createObjectURL(f);
    preview.style.display = "block";
  }
};

/* =========================
   SUBMIT INSERT
========================= */
insertForm.onsubmit = async (e)=>{
  e.preventDefault();
  msg.textContent = "Mengirim...";

  let photo_base64 = "";
  let photo_type = "";

  if(photo.files[0]){
    photo_base64 = await toBase64(photo.files[0]);
    photo_type = photo.files[0].type;
  }

  const payload = new URLSearchParams();
  payload.append("mode","insert");
  payload.append("token", session.token);
  payload.append("name", name.value);
  payload.append("domisili", domisili.value);
  payload.append("relationship", relationship.value);
  payload.append("photo_base64", photo_base64);
  payload.append("photo_type", photo_type);
  payload.append("notes", notes.value);
  payload.append("parentIdAyah", parentIdAyah.value);
  payload.append("parentIdIbu", parentIdIbu.value);
  payload.append("spouseId", spouseId.value);
  payload.append("orderChild", orderChild.value);
  payload.append("status", status.value);
  payload.append("role","user");

  const r = await fetch(API_URL,{method:"POST",body:payload});
  const j = await r.json();

  if(j.status==="success"){
    msg.textContent = "‚úÖ Berhasil ditambahkan";
    insertForm.reset();
    preview.style.display="none";
    loadMembers();
  }else{
    msg.textContent = "‚ùå " + j.message;
  }
};

/* INIT */
loadMembers();
</script>

</body>
</html>
