<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>FamilyTree — Dashboard</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 900px;
            margin: auto;
        }
        h2 { margin-bottom: 5px; }
        .box {
            border: 1px solid #ccc;
            padding: 15px;
            margin-bottom: 25px;
            border-radius: 6px;
        }
        label { font-weight: bold; display: block; margin-top: 12px; }
        input, select, textarea {
            width: 100%;
            padding: 8px;
            margin-top: 4px;
        }
        .btn {
            padding: 8px 12px;
            border: none;
            cursor: pointer;
            margin-top: 12px;
            border-radius: 5px;
        }
        .btn-save { background: #2196f3; color: white; }
        .btn-delete { background: #e53935; color: white; }
        .btn-edit { background: #4caf50; color: white; }
        .card {
            border: 1px solid #ccc;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
        }
        img.photo {
            width: 90px;
            border-radius: 6px;
            margin-top: 10px;
        }
    </style>
</head>

<body>

    <h2>Tambah Anggota Keluarga</h2>
    <div id="msg" style="color:red;font-weight:bold;"></div>

    <div class="box">
        <form id="addForm">

            <label>Nama</label>
            <input type="text" id="name" required>

            <label>Ayah</label>
            <select id="father"></select>

            <label>Ibu</label>
            <select id="mother"></select>

            <label>Pasangan</label>
            <select id="spouse"></select>

            <label>Urutan Anak</label>
            <input type="number" id="birthOrder" min="1" placeholder="misal: 1">

            <label>Status</label>
            <select id="status">
                <option value="hidup">Hidup</option>
                <option value="meninggal">Meninggal</option>
            </select>

            <label>Domisili</label>
            <input type="text" id="domisili" placeholder="Alamat / kota / negara">

            <label>Catatan</label>
            <textarea id="notes"></textarea>

            <label>Foto</label>
            <input type="file" id="photo" accept="image/*">
            <img id="preview" class="photo" style="display:none;">

            <button type="submit" class="btn btn-save">Simpan</button>

        </form>
    </div>


    <h2>Daftar Anggota</h2>
    <div id="list">Memuat data...</div>


<script>
/* ===========================
   KONFIGURASI
=========================== */
const API_URL = "https://script.google.com/macros/s/AKfycbxZFjqYNCFc5E3zXgBGwg2X8uYkSXr8BbLW7TRVcrVaKx4bKs6QEgIl95VMEfXZLGN2lg/exec"; // <- WAJIB diganti


/* ===========================
   DOM
=========================== */
const msg = document.getElementById("msg");
const father = document.getElementById("father");
const mother = document.getElementById("mother");
const spouse = document.getElementById("spouse");
const photo = document.getElementById("photo");
const preview = document.getElementById("preview");


/* ===========================
   PREVIEW FOTO
=========================== */
photo.addEventListener("change", () => {
    const file = photo.files[0];
    if (file) {
        preview.src = URL.createObjectURL(file);
        preview.style.display = "block";
    }
});


/* ===========================
   LOAD ALL MEMBERS (GET — NO CORS)
=========================== */
async function loadMembers() {
    try {
        const res = await fetch(`${API_URL}?mode=getData&ts=${Date.now()}`);
        const j = await res.json();

        if (j.status !== "success") {
            msg.textContent = "Gagal memuat data!";
            return;
        }

        fillDropdowns(j.data);
        renderList(j.data);

    } catch (err) {
        msg.textContent = "Error load: " + err.message;
    }
}


/* ===========================
   ISI DROPDOWN AYAH/IBU/PASANGAN
=========================== */
function fillDropdowns(arr) {
    const opts = `<option value="">(Tidak ada)</option>` +
                 arr.map(m => `<option value="${m.id}">${m.name}</option>`).join("");

    father.innerHTML = opts;
    mother.innerHTML = opts;
    spouse.innerHTML = opts;
}



/* ===========================
   RENDER LIST
=========================== */
function renderList(arr) {
    const container = document.getElementById("list");
    container.innerHTML = "";

    arr.forEach(m => {
        let photoHtml = "";
        if (m.photoURL) {
            const id = (m.photoURL.match(/[-\w]{25,}/) || [null])[0];
            if (id) {
                photoHtml = `<img class="photo" src="https://drive.google.com/uc?export=view&id=${id}">`;
            }
        }

        container.insertAdjacentHTML("beforeend", `
            <div class="card">
                <div><strong>${m.name}</strong></div>
                ${photoHtml}
                <div>ID: ${m.id}</div>

                <button class="btn btn-edit" onclick="location.href='edit.html?id=${m.id}'">Edit</button>
                <button class="btn btn-delete" onclick="deleteMember('${m.id}')">Hapus</button>
            </div>
        `);
    });
}



/* ===========================
   SIMPAN DATA (POST + FORMDATA = NO CORS)
=========================== */
document.getElementById("addForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    msg.textContent = "Menyimpan...";

    const fd = new FormData();
    fd.append("mode", "add");
    fd.append("name", document.getElementById("name").value);
    fd.append("parentIdAyah", father.value);
    fd.append("parentIdIbu", mother.value);
    fd.append("spouseId", spouse.value);
    fd.append("orderChild", document.getElementById("birthOrder").value);
    fd.append("status", document.getElementById("status").value);
    fd.append("domisili", document.getElementById("domisili").value);
    fd.append("notes", document.getElementById("notes").value);

    if (photo.files[0]) {
        fd.append("photo", photo.files[0]);
    }

    try {
        const res = await fetch(API_URL, { method: "POST", body: fd });
        const j = await res.json();

        if (j.status === "success") {
            msg.textContent = "Berhasil disimpan!";
            document.getElementById("addForm").reset();
            preview.style.display = "none";
            loadMembers();
        } else {
            msg.textContent = "Gagal: " + j.message;
        }

    } catch (err) {
        msg.textContent = "Error: " + err.message;
    }
});



/* ===========================
   DELETE (POST + FORMDATA = NO CORS)
=========================== */
async function deleteMember(id) {
    if (!confirm("Yakin hapus?")) return;

    msg.textContent = "Menghapus...";

    const fd = new FormData();
    fd.append("mode", "delete");
    fd.append("id", id);

    try {
        const res = await fetch(API_URL, { method: "POST", body: fd });
        const j = await res.json();

        if (j.status === "success") {
            msg.textContent = "Berhasil dihapus!";
            loadMembers();
        } else {
            msg.textContent = "Gagal hapus!";
        }

    } catch (err) {
        msg.textContent = "Error hapus: " + err.message;
    }
}

window.deleteMember = deleteMember;


/* ===========================
   START
=========================== */
loadMembers();

</script>
</body>
</html>