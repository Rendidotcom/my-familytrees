<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>üå≥ Tambah Anggota Family Tree</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<script src="config.js"></script>
<script src="session.js"></script>

<style>
  body{background:#f4f7fa}
  .card{max-width:900px;margin:auto}
  .preview{max-width:140px;display:none}
</style>
</head>

<body>

<nav class="navbar navbar-dark bg-primary">
  <div class="container-fluid">
    <span class="navbar-brand">üå≥ Tambah Anggota</span>
    <div class="d-flex gap-2">
      <a href="dashboard.html" class="btn btn-light">Dashboard</a>
      <button id="btnLogout" class="btn btn-warning">Logout</button>
    </div>
  </div>
</nav>

<div class="container py-4">
  <div class="card shadow p-4">
    <h4 class="mb-3">Data Anggota Baru</h4>

    <form id="insertForm">

      <div class="mb-3">
        <label>Nama Lengkap</label>
        <input id="inputName" class="form-control" required>
      </div>

      <div class="mb-3">
        <label>Domisili</label>
        <input id="inputDomisili" class="form-control">
      </div>

      <div class="mb-3">
        <label>Hubungan / Relationship</label>
        <input id="inputRelationship" class="form-control">
      </div>

      <div class="row">
        <div class="col-md-4 mb-3">
          <label>Ayah</label>
          <select id="selectAyah" class="form-control"></select>
        </div>
        <div class="col-md-4 mb-3">
          <label>Ibu</label>
          <select id="selectIbu" class="form-control"></select>
        </div>
        <div class="col-md-4 mb-3">
          <label>Pasangan</label>
          <select id="selectSpouse" class="form-control"></select>
        </div>
      </div>

      <div class="mb-3">
        <label>Urutan Anak</label>
        <input id="inputOrderChild" type="number" class="form-control">
      </div>

      <div class="mb-3">
        <label>Status</label>
        <select id="selectStatus" class="form-control">
          <option value="active">Active</option>
          <option value="deleted">Deleted</option>
        </select>
      </div>

      <div class="mb-3">
        <label>Catatan</label>
        <textarea id="inputNotes" class="form-control"></textarea>
      </div>

      <div class="mb-3">
        <label>Foto (opsional)</label>
        <input id="inputPhoto" type="file" accept="image/*" class="form-control">
        <img id="photoPreview" class="img-thumbnail mt-2 preview">
      </div>

      <button class="btn btn-success">üöÄ Simpan Anggota</button>

      <div id="msg" class="mt-3 text-muted small"></div>
    </form>
  </div>
</div>

<script>
(() => {
  const API_URL = window.API_URL;
  const msg = document.getElementById("msg");

  const el = id => document.getElementById(id);

  /* =========================
     SESSION
  ========================= */
  const session = JSON.parse(localStorage.getItem("familyUser") || "null");
  if(!session || !session.token){
    location.href = "login.html";
    return;
  }

  el("btnLogout").onclick = () => {
    localStorage.removeItem("familyUser");
    location.href = "login.html";
  };

  /* =========================
     LOAD MEMBER OPTIONS
  ========================= */
  async function loadMembers(){
    const r = await fetch(`${API_URL}?mode=getData&ts=${Date.now()}`);
    const j = await r.json();
    if(j.status !== "success") return;

    fillSelect(el("selectAyah"), j.data);
    fillSelect(el("selectIbu"), j.data);
    fillSelect(el("selectSpouse"), j.data);
  }

  function fillSelect(selectEl, data){
    selectEl.innerHTML = `<option value="">(Tidak ada)</option>`;
    data.forEach(m=>{
      selectEl.insertAdjacentHTML(
        "beforeend",
        `<option value="${m.id}">${m.name}</option>`
      );
    });
  }

  /* =========================
     PHOTO HANDLING
  ========================= */
  function toBase64(file){
    return new Promise((resolve,reject)=>{
      const r = new FileReader();
      r.onload = ()=>resolve(r.result.split(",")[1]);
      r.onerror = reject;
      r.readAsDataURL(file);
    });
  }

  el("inputPhoto").addEventListener("change", () => {
    const f = el("inputPhoto").files[0];
    if(!f) return;
    el("photoPreview").src = URL.createObjectURL(f);
    el("photoPreview").style.display = "block";
  });

  /* =========================
     SUBMIT
  ========================= */
  el("insertForm").addEventListener("submit", async e => {
    e.preventDefault();
    msg.textContent = "Mengirim...";

    let photoBase64 = "";
    let photoType = "";

    const photoFile = el("inputPhoto").files[0];
    if(photoFile){
      photoBase64 = await toBase64(photoFile);
      photoType = photoFile.type;
    }

    const payload = new URLSearchParams();
    payload.append("mode","insert");
    payload.append("token", session.token);
    payload.append("name", el("inputName").value.trim());
    payload.append("domisili", el("inputDomisili").value.trim());
    payload.append("relationship", el("inputRelationship").value.trim());
    payload.append("photo_base64", photoBase64);
    payload.append("photo_type", photoType);
    payload.append("notes", el("inputNotes").value.trim());
    payload.append("parentIdAyah", el("selectAyah").value);
    payload.append("parentIdIbu", el("selectIbu").value);
    payload.append("spouseId", el("selectSpouse").value);
    payload.append("orderChild", el("inputOrderChild").value);
    payload.append("status", el("selectStatus").value);
    payload.append("role","user");

    const r = await fetch(API_URL, { method:"POST", body: payload });
    const j = await r.json();

    if(j.status === "success"){
      msg.textContent = "‚úÖ Anggota berhasil ditambahkan";
      el("insertForm").reset();
      el("photoPreview").style.display = "none";
      loadMembers();
    } else {
      msg.textContent = "‚ùå " + j.message;
    }
  });

  loadMembers();
})();
</script>

</body>
</html>
