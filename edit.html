<script>
// ====================================================
// KONFIGURASI
// ====================================================
const API_URL = "https://script.google.com/macros/s/AKfycbyjR22fuPOGgHsyVHtic0_TGlkG5StwSAQx5JMVaApl5iQYRjFIbvsKKMpcMR7MlWuT5w/exec";
const id = new URLSearchParams(window.location.search).get("id");
const activeUser = localStorage.getItem("activeUser");
let allMembers = [];

// ====================================================
// Proteksi login
// ====================================================
if (!activeUser) {
  alert("‚ö† Anda harus login terlebih dahulu!");
  window.location.href = "login.html";
}

// ====================================================
// Proteksi akses edit
// ====================================================
if (id !== activeUser) {
  alert("üö´ Anda tidak punya izin mengedit profil orang lain!");
  window.location.href = "dashboard.html";
}

// ====================================================
// LOGGING HELPER
// ====================================================
function log(msg) {
  const box = document.getElementById("debug");
  box.innerHTML += `<div>‚û° ${msg}</div>`;
  box.scrollTop = box.scrollHeight;
}

// ====================================================
// LOAD MEMBER LIST INTO DROPDOWN
// ====================================================
async function loadAllMembers() {
  try {
    const res = await fetch(API_URL + "?mode=getData");
    const json = await res.json();
    allMembers = json.data || [];
    populateSelects();
  } catch (err) {
    log("‚ùå Gagal load members: " + err);
  }
}

function populateSelects() {
  const fields = {
    parentIdAyah: "Ayah",
    parentIdIbu: "Ibu",
    spouseId: "Pasangan"
  };

  Object.entries(fields).forEach(([id, label]) => {
    const el = document.getElementById(id);
    el.innerHTML = `<option value="">-- Pilih ${label} --</option>`;
    allMembers.forEach(m => el.insertAdjacentHTML("beforeend", `<option value="${m.id}">${m.name}</option>`));
  });
}

// ====================================================
// LOAD EXISTING DATA
// ====================================================
async function loadData() {
  await loadAllMembers();

  try {
    const res = await fetch(API_URL + "?mode=getOne&id=" + id);
    const json = await res.json();
    const d = json.data;

    if (!d) return alert("‚ö† Data tidak ditemukan!");

    // Set existing values
    document.getElementById("name").value = d.name || "";
    document.getElementById("domisili").value = d.domisili || "";
    document.getElementById("relationship").value = d.relationship || "";
    document.getElementById("notes").value = d.notes || "";
    document.getElementById("parentIdAyah").value = d.parentIdAyah || "";
    document.getElementById("parentIdIbu").value = d.parentIdIbu || "";
    document.getElementById("spouseId").value = d.spouseId || "";
    document.getElementById("orderChild").value = d.orderChild || "";
    document.getElementById("status").value = d.status || "";

    log("‚úî Data berhasil dimuat.");
  } catch (err) {
    log("‚ùå Error loadData: " + err);
  }
}

// ====================================================
// SUBMIT UPDATE
// ====================================================
document.getElementById("editForm").addEventListener("submit", async function (e) {
  e.preventDefault();

  const payload = {
    mode: "update",
    id,
    name: name.value,
    domisili: domisili.value,
    relationship: relationship.value,
    parentIdAyah: parentIdAyah.value,
    parentIdIbu: parentIdIbu.value,
    spouseId: spouseId.value,
    notes: notes.value,
    orderChild: orderChild.value,
    status: status.value
  };

  const file = photo.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = async () => {
      payload.photo_type = file.type;
      payload.photo_base64 = reader.result.split(",")[1];
      await sendUpdate(payload);
    };
    reader.readAsDataURL(file);
  } else {
    await sendUpdate(payload);
  }
});

async function sendUpdate(payload) {
  try {
    const res = await fetch(
      `${API_URL}?mode=proxyUpdate&payload=${encodeURIComponent(JSON.stringify(payload))}`
    );
    const json = await res.json();

    if (json.status === "success") {
      alert("‚úÖ Data berhasil diperbarui!");
      window.location.href = "dashboard.html";
    } else {
      throw new Error(json.message);
    }
  } catch (err) {
    alert("‚ùå Gagal update: " + err.message);
  }
}

// ====================================================
// INIT
// ====================================================
document.addEventListener("DOMContentLoaded", loadData);
</script>
