<!DOCTYPE html>
<html lang="id">
<head>
  <script type="module">
import { API_URL } from "./config.js";
window.API_URL = API_URL;
</script>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Edit Profil Anggota</title>
<style>
body{font-family:Arial;background:#eef1f5;margin:0;padding:0;display:flex;justify-content:center}
nav{position:fixed;top:0;width:100%;background:#3498db;padding:12px;display:flex;justify-content:space-around;color:#fff}
nav a{text-decoration:none;color:white;font-weight:bold}
.container{background:#fff;padding:20px;margin-top:80px;border-radius:12px;width:92%;max-width:520px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
label{display:block;margin-top:10px;font-weight:600}
input,select,textarea{width:100%;padding:10px;margin-top:6px;border-radius:8px;border:1px solid #ccc;font-size:15px}
button{margin-top:15px;padding:12px;border-radius:8px;border:0;background:#2ecc71;color:#fff;cursor:pointer;font-size:16px}
button.red{background:#e74c3c}
.small{font-size:14px;color:#555;margin-top:6px}
.hidden{display:none}
</style>
</head>
<body>

<nav>
  <a href="dashboard.html">üìã Dashboard</a>
  <span id="addBtn"></span>
  <a href="tree.html">üå≥ Tree</a>
  <a href="#" onclick="logout()">üö™ Logout</a>
</nav>

<div class="container">
  <h3>‚úèÔ∏è Edit Profil</h3>

  <form id="formEdit">
    <label>Nama</label>
    <input id="name" required>
    <label>Domisili</label>
    <input id="domisili">
    <label>Hubungan</label>
    <select id="relationship">
      <option value="">-- Pilih --</option>
      <option>Ayah</option>
      <option>Ibu</option>
      <option>Anak</option>
      <option>Saudara</option>
    </select>
    <label>Ayah</label>
    <select id="parentIdAyah"><option value="">-- Tidak ada --</option></select>
    <label>Ibu</label>
    <select id="parentIdIbu"><option value="">-- Tidak ada --</option></select>
    <label>Pasangan</label>
    <select id="spouseId"><option value="">-- Belum menikah --</option></select>
    <label>Urutan Anak</label>
    <input type="number" id="orderChild" min="1">
    <label>Status</label>
    <select id="status">
      <option value="">-- Pilih --</option>
      <option value="hidup">Masih Hidup</option>
      <option value="meninggal">Sudah Meninggal</option>
    </select>
    <label>Catatan</label>
    <textarea id="notes" rows="3"></textarea>
    <label>Foto (opsional)</label>
    <input type="file" id="photo" accept="image/*">
    <button type="submit">üíæ Simpan Perubahan</button>
    <button type="button" class="red hidden" id="resetBtn" onclick="resetPin()">üîë Reset PIN</button>
    <div id="msg" class="small"></div>
  </form>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycby8WX2QXb_mc0lfP6AaAFqRNDIMyRkznr7o16zLU3BG9wV39uBG_qwDrxuIHOCbnrlBkw/exec";
const urlID = new URLSearchParams(location.search).get("id");
let session = JSON.parse(localStorage.getItem("familyUser")||"null");

// ===== TOKEN VALIDATION =====
async function validateToken(){
  if(!session){ alert("‚ö† Anda harus login!"); return location.href="login.html"; }
  try{
    const res = await fetch(`${API_URL}?mode=validate&token=${session.token}`);
    const j = await res.json();
    if(j.status!=="success"){ alert("üö´ Sesi berakhir!"); logout(); }
    else { session.role=j.role; session.name=j.name; updateAdminMenu(); }
  }catch(e){ console.error(e); logout(); }
}
validateToken();

// ===== ADMIN MENU =====
function updateAdminMenu(){
  document.getElementById("addBtn").innerHTML = session.role==="admin"?`<a href="index.html">‚ûï Tambah</a>`:"";
}

// ===== ACCESS RULE =====
if(session.role!=="admin" && session.id!==urlID){
  alert("‚õî Tidak bisa mengedit profil orang lain."); location.href="dashboard.html";
}
if(session.role==="admin"){ document.getElementById("resetBtn").classList.remove("hidden"); }

// ===== LOAD DATA =====
function base64(file){ return new Promise((resolve,reject)=>{const r=new FileReader();r.onload=()=>resolve(r.result);r.onerror=reject;r.readAsDataURL(file);}); }

async function loadDropdowns(){
  const res = await fetch(`${API_URL}?mode=getData`);
  const j = await res.json(); if(j.status!=="success") return;
  const people=j.data;
  ["parentIdAyah","parentIdIbu","spouseId"].forEach(s=>{document.getElementById(s).innerHTML=`<option value="">-- Pilih --</option>`;});
  people.forEach(p=>["parentIdAyah","parentIdIbu","spouseId"].forEach(s=>document.getElementById(s).insertAdjacentHTML("beforeend", `<option value="${p.id}">${p.name}</option>`)));
}

async function loadData(){
  await loadDropdowns();
  const res = await fetch(`${API_URL}?mode=getOne&id=${urlID}`);
  const j = await res.json();
  if(j.status!=="success"){ alert("‚ùå Data tidak ditemukan!"); location.href="dashboard.html"; return; }
  const p=j.data;
  document.getElementById("name").value=p.name;
  document.getElementById("domisili").value=p.domisili;
  document.getElementById("relationship").value=p.relationship;
  document.getElementById("parentIdAyah").value=p.parentIdAyah;
  document.getElementById("parentIdIbu").value=p.parentIdIbu;
  document.getElementById("spouseId").value=p.spouseId;
  document.getElementById("orderChild").value=p.orderChild;
  document.getElementById("status").value=p.status;
  document.getElementById("notes").value=p.notes;
}
loadData();

// ===== SUBMIT FORM =====
document.getElementById("formEdit").addEventListener("submit", async e=>{
  e.preventDefault(); const msg=document.getElementById("msg"); msg.textContent="‚è≥ Menyimpan...";
  const file=document.getElementById("photo").files[0]; let base64img="";
  if(file) base64img=(await base64(file)).split(",")[1];
  const payload={
    mode:"update",
    token:session.token,
    id:urlID,
    name:name.value.trim(),
    domisili:domisili.value.trim(),
    relationship:relationship.value,
    parentIdAyah:parentIdAyah.value,
    parentIdIbu:parentIdIbu.value,
    spouseId:spouseId.value,
    orderChild:orderChild.value,
    status:status.value,
    notes:notes.value,
    photo_base64:base64img,
    photo_type:file?file.type:""
  };
  try{
    const res=await fetch(API_URL,{method:"POST",body:JSON.stringify(payload)});
    const j=await res.json();
    if(j.status==="success"){ msg.textContent="‚úî Perubahan disimpan!"; setTimeout(()=>location.href="dashboard.html",1200); }
    else{ msg.textContent="‚ùå Gagal menyimpan: "+j.message; }
  }catch(err){ msg.textContent="‚ùå Error: "+err.message; }
});

// ===== RESET PIN =====
async function resetPin(){
  const newPin=prompt("Masukkan PIN baru (4 digit):");
  if(!newPin||newPin.length!==4) return alert("‚ùå PIN harus 4 digit!");
  try{
    const res=await fetch(`${API_URL}?mode=resetpin&id=${urlID}&pin=${newPin}&token=${session.token}`);
    const j=await res.json();
    alert(j.status==="success"?"üîë PIN berhasil direset!":"‚ùå Gagal reset PIN");
  }catch(e){ alert("‚ùå Error: "+e.message); }
}

// ===== LOGOUT =====
function logout(){ localStorage.removeItem("familyUser"); location.href="login.html"; }
</script>

</body>
</html>
