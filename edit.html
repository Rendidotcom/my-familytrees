<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Edit Anggota</title>
<style>
body{font-family:Arial;background:#eef1f5;margin:0;padding:0;display:flex;justify-content:center}
nav{position:fixed;top:0;width:100%;background:#3498db;padding:12px;display:flex;justify-content:space-around;color:#fff}
.container{background:#fff;padding:18px;margin-top:80px;border-radius:12px;width:92%;max-width:520px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
label{display:block;margin-top:8px;font-weight:600}
input,select,textarea{width:100%;padding:10px;margin-top:6px;border-radius:8px;border:1px solid #ccc}
button{margin-top:12px;padding:12px;border-radius:8px;border:0;background:#2ecc71;color:#fff;cursor:pointer}
.small{font-size:13px;color:#666;margin-top:6px}
</style>
</head>
<body>
<nav>
  <a href="dashboard.html">ğŸ“‹ Dashboard</a>
  <a href="index.html">â• Tambah</a>
  <a href="tree.html">ğŸŒ³ Tree</a>
  <a href="#" onclick="logout()">ğŸšª Logout</a>
</nav>

<div class="container">
  <h3>âœï¸ Edit Profil</h3>
  <form id="formEdit">
    <label>Nama</label><input id="name" required>
    <label>Domisili</label><input id="domisili" required>
    <label>Hubungan</label>
    <select id="relationship"><option value="">-- Pilih --</option><option>Ayah</option><option>Ibu</option><option>Anak</option><option>Saudara</option></select>
    <label>Ayah</label><select id="parentIdAyah"><option value="">-- Tidak ada --</option></select>
    <label>Ibu</label><select id="parentIdIbu"><option value="">-- Tidak ada --</option></select>
    <label>Pasangan</label><select id="spouseId"><option value="">-- Belum menikah --</option></select>
    <label>Urutan anak</label><input id="orderChild" type="number" min="1">
    <label>Status</label><select id="status"><option value="">-- Pilih --</option><option value="hidup">Masih Hidup</option><option value="meninggal">Sudah Meninggal</option></select>
    <label>Catatan</label><textarea id="notes" rows="3"></textarea>
    <label>Foto baru (opsional)</label><input type="file" id="photo" accept="image/*">
    <button type="submit">ğŸ’¾ Simpan Perubahan</button>
    <div id="msg" class="small"></div>
  </form>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycby8WX2QXb_mc0lfP6AaAFqRNDIMyRkznr7o16zLU3BG9wV39uBG_qwDrxuIHOCbnrlBkw/exec";
const id = new URLSearchParams(location.search).get('id');
const session = JSON.parse(localStorage.getItem('familyUser') || 'null');
if(!session || !session.id){ alert('âš  Harap login'); location.href='login.html' }
if(session.id !== id){ alert('â›” Hanya boleh edit profil sendiri'); location.href='dashboard.html' }

function toBase64(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }) }

async function loadDropdowns(){
  const res = await fetch(`${API_URL}?mode=getData&nocache=${Date.now()}`);
  const j = await res.json();
  if(j.status!=='success') return;
  const data = j.data;
  const fields = ['parentIdAyah','parentIdIbu','spouseId'];
  for(const f of fields) document.getElementById(f).innerHTML = `<option value="">-- Pilih --</option>`;
  for(const m of data){
    const opt = `<option value="${m.id}">${m.name}</option>`;
    document.getElementById('parentIdAyah').insertAdjacentHTML('beforeend', opt);
    document.getElementById('parentIdIbu').insertAdjacentHTML('beforeend', opt);
    document.getElementById('spouseId').insertAdjacentHTML('beforeend', opt);
  }
}

async function loadData(){
  await loadDropdowns();
  const res = await fetch(`${API_URL}?mode=getOne&id=${encodeURIComponent(id)}&nocache=${Date.now()}`);
  const j = await res.json();
  if(j.status!=='success'){ alert('âŒ Data tidak ditemukan'); location.href='dashboard.html'; return; }
  const p = j.data;
  document.getElementById('name').value = p.name || '';
  document.getElementById('domisili').value = p.domisili || '';
  document.getElementById('relationship').value = p.relationship || '';
  document.getElementById('parentIdAyah').value = p.parentIdAyah || '';
  document.getElementById('parentIdIbu').value = p.parentIdIbu || '';
  document.getElementById('spouseId').value = p.spouseId || '';
  document.getElementById('orderChild').value = p.orderChild || '';
  document.getElementById('status').value = p.status || '';
  document.getElementById('notes').value = p.notes || '';
}

document.getElementById('formEdit').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const msg = document.getElementById('msg');
  msg.textContent = 'â³ Mengirim...';
  const file = document.getElementById('photo').files[0];
  let base64 = '';
  if(file) base64 = (await toBase64(file)).split(',')[1];

  const payload = {
    mode: 'update',
    id,
    name: document.getElementById('name').value.trim(),
    domisili: document.getElementById('domisili').value.trim(),
    relationship: document.getElementById('relationship').value,
    parentIdAyah: document.getElementById('parentIdAyah').value,
    parentIdIbu: document.getElementById('parentIdIbu').value,
    spouseId: document.getElementById('spouseId').value,
    orderChild: document.getElementById('orderChild').value,
    status: document.getElementById('status').value,
    notes: document.getElementById('notes').value.trim(),
    photo_base64: base64,
    photo_type: file ? file.type : ''
  };

  try{
    const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
    const j = await res.json();
    if(j.status === 'success'){ msg.textContent = 'âœ” Disimpan'; setTimeout(()=>location.href='dashboard.html',800); }
    else msg.textContent = 'âŒ Gagal: '+(j.message||'');
  }catch(err){ msg.textContent = 'âŒ Error: '+err.message; console.error(err); }
});

function logout(){ localStorage.removeItem('familyUser'); location.href='login.html'; }

loadData();
</script>
</body>
</html>
