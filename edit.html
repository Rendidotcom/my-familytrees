<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Edit Profil Anggota</title>

<style>
body{font-family:Arial;background:#eef1f5;margin:0;padding:0;display:flex;justify-content:center}
nav{position:fixed;top:0;width:100%;background:#3498db;padding:12px;display:flex;justify-content:space-around;color:#fff}
nav a{text-decoration:none;color:white;font-weight:bold}
.container{background:#fff;padding:20px;margin-top:80px;border-radius:12px;width:92%;max-width:520px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
label{display:block;margin-top:10px;font-weight:600}
input,select,textarea{width:100%;padding:10px;margin-top:6px;border-radius:8px;border:1px solid #ccc;font-size:15px}
button{margin-top:15px;padding:12px;border-radius:8px;border:0;background:#2ecc71;color:#fff;cursor:pointer;font-size:16px}
button.red{background:#e74c3c}
.small{font-size:14px;color:#555;margin-top:6px}
</style>
</head>

<body>

<nav>
  <a href="dashboard.html">ğŸ“‹ Dashboard</a>
  <a href="index.html">â• Tambah</a>
  <a href="tree.html">ğŸŒ³ Tree</a>
  <a href="#" onclick="logout()">ğŸšª Logout</a>
</nav>

<div class="container">
  <h3>âœï¸ Edit Profil</h3>

  <form id="formEdit">
    
    <label>Nama</label>
    <input id="name" required>

    <label>Domisili</label>
    <input id="domisili">

    <label>Hubungan</label>
    <select id="relationship">
      <option value="">-- Pilih --</option>
      <option>Ayah</option>
      <option>Ibu</option>
      <option>Anak</option>
      <option>Saudara</option>
    </select>

    <label>Ayah</label>
    <select id="parentIdAyah"><option value="">-- Tidak ada --</option></select>

    <label>Ibu</label>
    <select id="parentIdIbu"><option value="">-- Tidak ada --</option></select>

    <label>Pasangan</label>
    <select id="spouseId"><option value="">-- Belum menikah --</option></select>

    <label>Urutan Anak</label>
    <input type="number" id="orderChild" min="1">

    <label>Status</label>
    <select id="status">
      <option value="">-- Pilih --</option>
      <option value="hidup">Masih Hidup</option>
      <option value="meninggal">Sudah Meninggal</option>
    </select>

    <label>Catatan</label>
    <textarea id="notes" rows="3"></textarea>

    <label>Foto (opsional)</label>
    <input type="file" id="photo" accept="image/*">

    <button type="submit">ğŸ’¾ Simpan Perubahan</button>
    <button type="button" class="red" onclick="resetPin()">ğŸ”‘ Reset PIN</button>

    <div id="msg" class="small"></div>
  </form>
</div>


<script>
const API_URL = "https://script.google.com/macros/s/AKfycby8WX2QXb_mc0lfP6AaAFqRNDIMyRkznr7o16zLU3BG9wV39uBG_qwDrxuIHOCbnrlBkw/exec";

const urlID = new URLSearchParams(location.search).get("id");
const session = JSON.parse(localStorage.getItem("familyUser") || "null");

// ========== Proteksi ==========
if(!session){
  alert("âš  Anda harus login!");
  location.href="login.html";
}

if(session.id !== urlID){
  alert("â›” Anda hanya bisa mengedit profil sendiri.");
  location.href="dashboard.html";
}

function base64(file){
  return new Promise((resolve,reject)=>{
    const r = new FileReader();
    r.onload = ()=>resolve(r.result);
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

async function loadDropdowns(){
  const res = await fetch(`${API_URL}?mode=getData`);
  const j = await res.json();
  if(j.status !== "success") return;

  const people = j.data;

  ["parentIdAyah","parentIdIbu","spouseId"].forEach(select=>{
    document.getElementById(select).innerHTML = `<option value="">-- Pilih --</option>`;
  });

  people.forEach(p=>{
    const opt = `<option value="${p.id}">${p.name}</option>`;
    document.getElementById("parentIdAyah").insertAdjacentHTML("beforeend", opt);
    document.getElementById("parentIdIbu").insertAdjacentHTML("beforeend", opt);
    document.getElementById("spouseId").insertAdjacentHTML("beforeend", opt);
  });
}

async function loadData(){
  await loadDropdowns();

  const res = await fetch(`${API_URL}?mode=getOne&id=${urlID}`);
  const j = await res.json();

  if(j.status!=="success"){
    alert("âŒ Data tidak ditemukan!");
    location.href="dashboard.html";
    return;
  }

  const p = j.data;
  document.getElementById("name").value = p.name;
  document.getElementById("domisili").value = p.domisili;
  document.getElementById("relationship").value = p.relationship;
  document.getElementById("parentIdAyah").value = p.parentIdAyah;
  document.getElementById("parentIdIbu").value = p.parentIdIbu;
  document.getElementById("spouseId").value = p.spouseId;
  document.getElementById("orderChild").value = p.orderChild;
  document.getElementById("status").value = p.status;
  document.getElementById("notes").value = p.notes;
}

document.getElementById("formEdit").addEventListener("submit", async e=>{
  e.preventDefault();
  const msg = document.getElementById("msg");
  msg.textContent = "â³ Menyimpan...";

  const file = document.getElementById("photo").files[0];
  let base64img = "";
  if(file) base64img = (await base64(file)).split(",")[1];

  const payload = {
    mode:"update",
    id:urlID,
    name:document.getElementById("name").value.trim(),
    domisili:document.getElementById("domisili").value.trim(),
    relationship:document.getElementById("relationship").value,
    parentIdAyah:document.getElementById("parentIdAyah").value,
    parentIdIbu:document.getElementById("parentIdIbu").value,
    spouseId:document.getElementById("spouseId").value,
    orderChild:document.getElementById("orderChild").value,
    status:document.getElementById("status").value,
    notes:document.getElementById("notes").value,
    photo_base64:base64img,
    photo_type:file ? file.type : ""
  };

  const res = await fetch(API_URL,{
    method:"POST",
    body:JSON.stringify(payload)
  });

  const j = await res.json();

  if(j.status==="success"){
    msg.textContent = "âœ” Perubahan disimpan!";
    setTimeout(()=>location.href="dashboard.html",1000);
  } else {
    msg.textContent = "âŒ Gagal menyimpan!";
  }
});

async function resetPin(){
  const newPin = prompt("Masukkan PIN baru (4 digit):");
  if(!newPin || newPin.length !== 4) return alert("âŒ PIN harus 4 digit!");

  const res = await fetch(`${API_URL}?mode=resetpin&id=${session.id}&pin=${newPin}`);
  const j = await res.json();

  alert(j.status==="success" ? "ğŸ”‘ PIN berhasil direset!" : "âŒ Gagal reset PIN");
}

function logout(){
  localStorage.removeItem("familyUser");
  location.href="login.html";
}

loadData();
</script>
</body>
</html>
