<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Detail Anggota</title>
<style>
body {
  font-family: Arial;
  background: #eef1f5;
  display: flex;
  justify-content: center;
}

.box {
  background: white;
  padding: 25px;
  margin-top: 40px;
  width: 90%;
  max-width: 420px;
  border-radius: 15px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

img {
  width: 125px;
  height: 125px;
  border-radius: 50%;
  object-fit: cover;
  margin: auto;
  display: block;
  border:3px solid #ddd;
}

button {
  width: 100%;
  padding: 12px;
  margin-top: 8px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}

.btn-edit { background: #4A90E2; color: white; }
.btn-delete { background: #e74c3c; color: white; }
.btn-back { background: #7f8c8d; color: white; }

h3 {
  text-align:center;
}

.tag {
  display:inline-block;
  padding:4px 8px;
  border-radius:6px;
  font-size: 12px;
  margin-left:6px;
}

.alive { background:#27ae60;color:white; }
.dead { background:#7f8c8d;color:white; }

.order {
  background:#f39c12; 
  color:white; 
  padding:4px 8px; 
  border-radius:6px; 
  font-size:12px;
}
</style>
</head>
<body>

<div class="box">
  <div id="content">‚è≥ Memuat data...</div>

  <div id="actions" style="display:none;">
    <button class="btn-edit" id="editBtn">‚úèÔ∏è Edit Profil</button>
    <button class="btn-delete" id="deleteBtn">üóë Hapus Profil</button>
  </div>

  <button class="btn-back" onclick="history.back()">‚¨Ö Kembali</button>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzRg74Zyz9ox0gy0se3CS_QWWzkzmJyUk2524KO6C0zAARDO1f5pj4w75dXAr8RoP7LzA/exec";
const id = new URLSearchParams(window.location.search).get("id");
const activeUser = localStorage.getItem("activeUser");

// ===============================
// MUAT DETAIL
// ===============================
async function loadDetail() {
  const content = document.getElementById("content");
  content.innerHTML = "‚è≥ Memuat data...";

  try {
    const res = await fetch(`${API_URL}?mode=getData`);
    const json = await res.json();
    const data = json.data || [];

    const person = data.find(p => p.id === id);
    if (!person) return content.innerHTML = "‚ùå Data tidak ditemukan.";

    // Mapping relasi
    const map = Object.fromEntries(data.map(p => [p.id, p.name]));

    const photo = convertDriveURL(person.photoURL);
    const ayah = map[person.parentIdAyah] || "-";
    const ibu = map[person.parentIdIbu] || "-";
    const pasangan = map[person.spouseId] || "-";
    const anak = data
      .filter(p => p.parentIdAyah === id || p.parentIdIbu === id)
      .map(p => p.name)
      .join(", ") || "-";

    const badge = person.status === "meninggal" 
      ? `<span class="tag dead">‚ò† Meninggal</span>`
      : `<span class="tag alive">üü¢ Hidup</span>`;

    const order = person.orderChild 
      ? `<span class="order">Anak ke-${person.orderChild}</span>` 
      : "";

    content.innerHTML = `
      <img src="${photo}">
      <h3>${person.name} ${badge}</h3>
      <p style="text-align:center;">${order}</p>

      <p><b>Domisili:</b> ${person.domisili || "-"}</p>
      <p><b>Hubungan:</b> ${person.relationship || "-"}</p>
      <p><b>Ayah:</b> ${ayah}</p>
      <p><b>Ibu:</b> ${ibu}</p>
      <p><b>Pasangan:</b> ${pasangan}</p>
      <p><b>Anak:</b> ${anak}</p>
      <p><b>Catatan:</b> ${person.notes || "-"}</p>
    `;

    // üîê tampilkan tombol edit/hapus hanya jika login === pemilik data
    if (activeUser === id) document.getElementById("actions").style.display = "block";

    document.getElementById("editBtn").onclick = () => {
      window.location.href = `edit.html?id=${id}`;
    };

  } catch (err) {
    content.innerHTML = "‚ùå Gagal memuat data.";
  }
}

// ===============================
// KONVERSI URL FOTO DRIVE
// ===============================
function convertDriveURL(url) {
  if (!url) return "https://via.placeholder.com/120";
  const id = url.match(/[-\w]{25,}/)?.[0];
  return id ? `https://drive.google.com/uc?export=view&id=${id}` : url;
}

// ===============================
// HAPUS DATA
// ===============================
document.getElementById("deleteBtn")?.addEventListener("click", async () => {
  if (!confirm("‚ö† Yakin ingin menghapus profil ini?")) return;

  const res = await fetch(`${API_URL}?mode=delete&id=${id}`);
  const json = await res.json();

  alert(json.message || "Profil berhasil dihapus!");
  window.location.href = "dashboard.html";
});

// ===============================
// INISIALISASI
// ===============================
loadDetail();
</script>

</body>
</html>
