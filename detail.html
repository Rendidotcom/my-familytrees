<!DOCTYPE html>
<html lang="id">
<head>
  <script type="module">
import { API_URL } from "./config.js";
window.API_URL = API_URL;
</script>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Detail Anggota</title>
<style>
body{font-family:Arial;background:#eef1f5;margin:0;padding:0;display:flex;justify-content:center}
nav{position:fixed;top:0;width:100%;background:#3498db;padding:12px;display:flex;justify-content:space-around;color:#fff;font-weight:bold}
.container{
 background:#fff;margin-top:80px;padding:20px;width:92%;max-width:500px;
 border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06);text-align:center
}
img{
 width:120px;height:120px;object-fit:cover;border-radius:50%;margin-bottom:12px;
 border:4px solid #3498db
}
h2{margin:6px 0;font-size:22px}
p{margin:4px 0;color:#555;font-size:14px}
.btn{
 margin-top:15px;padding:12px;width:100%;
 background:#2ecc71;color:#fff;border:0;border-radius:10px;
 cursor:pointer;font-size:16px
}
.smallBtn{
 margin-top:10px;padding:10px;background:#34495e;color:#fff;
 border:0;border-radius:10px;cursor:pointer;width:100%
}
.hidden{display:none;}
</style>
</head>
<body>

<nav>
  <a href="dashboard.html">üìã Dashboard</a>
  <span id="addMenu"></span>
  <a href="tree.html">üå≥ Tree</a>
  <a href="#" onclick="logout()">üö™ Logout</a>
</nav>

<div class="container" id="detail">‚è≥ Memuat...</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycby8WX2QXb_mc0lfP6AaAFqRNDIMyRkznr7o16zLU3BG9wV39uBG_qwDrxuIHOCbnrlBkw/exec";
const id = new URLSearchParams(location.search).get("id");
let session = JSON.parse(localStorage.getItem("familyUser") || "null");

// ===== CEK LOGIN =====
if(!session){ 
  alert("‚ö† Harap login dulu!");
  location.href="login.html"; 
}

// ===== VALIDASI TOKEN GAS =====
async function validateToken(){
  try{
    const res = await fetch(`${API_URL}?mode=validate&token=${session.token}`);
    const j = await res.json();
    if(j.status !== "success"){
      alert("‚ö† Sesi login telah berakhir. Silakan login ulang.");
      logout();
    } else {
      session.name = j.name;
      session.role = j.role;
      // Admin menu
      if(session.role === "admin"){
        document.getElementById("addMenu").innerHTML = `<a href="index.html">‚ûï Tambah</a>`;
      }
    }
  }catch(e){
    console.error("Token validation error", e);
    logout();
  }
}
validateToken();

let allData = [];
let member = null;

// Resolve name dari ID
function resolveName(userid){
  if(!userid) return "‚Äî";
  const f = allData.find(x => x.id === userid);
  return f ? f.name : "‚Äî";
}

async function loadDetail(){
  try{
    // Ambil semua data untuk resolve nama
    const resAll = await fetch(`${API_URL}?mode=getData&nocache=${Date.now()}`);
    const jAll = await resAll.json();
    allData = jAll.data;

    // Ambil data member yang dipilih
    const resMember = await fetch(`${API_URL}?mode=getOne&id=${id}`);
    const jMember = await resMember.json();

    if(jMember.status !== "success"){
      document.getElementById("detail").innerHTML = "‚ùå Data tidak ditemukan";
      return;
    }

    member = jMember.data;

    const allowEdit = (session.role === "admin" || session.id === member.id);

    document.getElementById("detail").innerHTML = `
      <img src="${member.photoURL || 'https://via.placeholder.com/120'}">
      <h2>${member.name}</h2>

      <p><strong>Domisili:</strong> ${member.domisili || '‚Äî'}</p>
      <p><strong>Hubungan:</strong> ${member.relationship || '‚Äî'}</p>
      <p><strong>Status:</strong> ${member.status || '‚Äî'}</p>
      <p><strong>Ayah:</strong> ${resolveName(member.parentIdAyah)}</p>
      <p><strong>Ibu:</strong> ${resolveName(member.parentIdIbu)}</p>
      <p><strong>Pasangan:</strong> ${resolveName(member.spouseId)}</p>
      <p><strong>Catatan:</strong><br>${member.notes || 'Tidak ada catatan'}</p>

      <button class="btn ${allowEdit ? '' : 'hidden'}" onclick="editUser('${member.id}')">‚úè Edit Profil</button>
      <button class="smallBtn" onclick="history.back()">‚¨Ö Kembali</button>
    `;
  }catch(err){
    document.getElementById("detail").innerHTML = "‚ùå Error: "+err.message;
  }
}

// Redirect ke edit
function editUser(uid){
  location.href = `edit.html?id=${uid}`;
}

function logout(){
  localStorage.removeItem("familyUser");
  location.href="login.html";
}

loadDetail();
</script>

</body>
</html>
