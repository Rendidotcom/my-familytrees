<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Dashboard Anggota Keluarga</title>
<style>
body { font-family: Arial, sans-serif; background: #eef1f5; margin: 0; padding: 0; }
nav { position: fixed; top: 0; width: 100%; background: #3498db; padding: 12px; display: flex; justify-content: space-around; color: white; font-weight: bold; }
nav a { color: white; text-decoration: none; }
h2 { text-align: center; padding-top: 70px; color: #333; }
#list { width: 92%; max-width: 950px; margin: 20px auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
.member { display: flex; align-items: center; padding: 14px; border-bottom: 1px solid #ddd; }
.member img { width: 70px; height: 70px; border-radius: 50%; object-fit: cover; margin-right: 15px; }
.member-info { flex: 1; }
.member-buttons button { margin-top: 4px; display: block; width: 95px; padding: 6px; font-size: 12px; border-radius: 6px; border: none; cursor: pointer; }
.btn-detail { background: #4A90E2; color: white; }
.btn-edit { background: #27ae60; color: white; }
.btn-del { background: #e74c3c; color: white; }
.status-tag { padding: 3px 6px; border-radius: 5px; font-size: 10px; }
.status-alive { background: #b5ffbf; }
.status-dead { background: #ffb5b5; }
.order-badge { background: #ffd966; padding: 3px 6px; border-radius: 6px; font-size: 10px; }
</style>
</head>
<body>

<nav>
  <a href="dashboard.html">ğŸ“‹ Dashboard</a>
  <a href="index.html">â• Tambah</a>
  <a href="tree.html">ğŸŒ³ Family Tree</a>
  <a href="#" onclick="logout()">ğŸšª Logout</a>
</nav>

<h2>ğŸ“‹ Daftar Anggota Keluarga</h2>
<div id="list">Memuat data...</div>

<script>
const API_URL = "https://script.google.com/macros/s/YOUR_DEPLOY_ID/exec"; // Ganti dengan deploy terbaru

// ==========================
// PROTECT PAGE
// ==========================
const activeUser = JSON.parse(localStorage.getItem("familyUser") || "null");
if(!activeUser){
  alert("âš  Anda harus login terlebih dahulu!");
  window.location.href = "login.html";
}

// ==========================
// FORMAT FOTO
// ==========================
function convertDriveURL(url){
  if(!url) return "https://via.placeholder.com/70";
  const id = url.match(/[-\w]{25,}/)?.[0];
  return `https://drive.google.com/uc?export=view&id=${id}`;
}

// ==========================
// LOAD DATA
// ==========================
async function loadData(){
  const list = document.getElementById("list");
  list.innerHTML = "â³ Sedang memuat...";

  try{
    const res = await fetch(`${API_URL}?mode=getData&nocache=${Date.now()}`);
    const json = await res.json();

    if(json.status !== "success"){
      list.innerHTML = "âŒ Gagal mengambil data.";
      return;
    }

    const data = json.data;
    const map = Object.fromEntries(data.map(p=>[p.id,p]));

    data.sort((a,b)=>Number(a.orderChild||999)-Number(b.orderChild||999));

    let html = "";
    data.forEach(p=>{
      const photo = convertDriveURL(p.photoURL);
      const ayah = map[p.parentIdAyah]?.name || "-";
      const ibu = map[p.parentIdIbu]?.name || "-";
      const spouse = map[p.spouseId]?.name || "-";
      const anak = data.filter(c=>c.parentIdAyah==p.id||c.parentIdIbu==p.id)
                       .map(c=>c.name).join(", ") || "-";

      const statusTag = p.status === "meninggal"
        ? `<span class="status-tag status-dead">â˜  Meninggal</span>`
        : `<span class="status-tag status-alive">ğŸŸ¢ Hidup</span>`;

      const order = p.orderChild ? `<span class="order-badge">#${p.orderChild}</span>` : "";

      const buttons = p.id === activeUser.id
        ? `
          <button class="btn-detail" onclick="detail('${p.id}')">ğŸ” Detail</button>
          <button class="btn-edit" onclick="editMember('${p.id}')">âœï¸ Edit</button>
          <button class="btn-del" onclick="deleteMember('${p.id}')">ğŸ—‘ Hapus</button>
        `
        : `<button class="btn-detail" onclick="detail('${p.id}')">ğŸ‘ Lihat</button>`;

      html += `
      <div class="member">
        <img src="${photo}">
        <div class="member-info">
          <h4>${p.name} ${statusTag} ${order}</h4>
          <p>${p.relationship} â€¢ ${p.domisili}</p>
          <p><b>Ayah:</b> ${ayah}</p>
          <p><b>Ibu:</b> ${ibu}</p>
          <p><b>Pasangan:</b> ${spouse}</p>
          <p><b>Anak:</b> ${anak}</p>
          ${p.pinSet ? "<p>ğŸ”’ PIN sudah diatur</p>" : "<p>âš  PIN belum diatur</p>"}
        </div>
        <div class="member-buttons">${buttons}</div>
      </div>
      `;
    });

    list.innerHTML = html;
  }catch(err){
    list.innerHTML = `<div>âŒ Error: ${err.message}</div>`;
  }
}

// ==========================
// ACTION BUTTONS
// ==========================
function detail(id){ window.location.href = "detail.html?id="+id; }

function editMember(id){
  if(id!==activeUser.id) return alert("â›” Hanya bisa edit akun sendiri.");
  window.location.href = "edit.html?id="+id;
}

async function deleteMember(id){
  if(id!==activeUser.id) return alert("â›” Hanya bisa hapus akun sendiri.");
  if(!confirm("âš  Hapus akun ini permanen?")) return;

  const res = await fetch(`${API_URL}?mode=delete&id=${id}`);
  const json = await res.json();

  if(json.status==="success"){
    alert("ğŸ—‘ Akun dihapus.");
    localStorage.removeItem("familyUser");
    window.location.href = "login.html";
  }else{
    alert("âŒ Error: "+json.message);
  }
}

function logout(){
  localStorage.removeItem("familyUser");
  window.location.href = "login.html";
}

// INIT
document.addEventListener("DOMContentLoaded", loadData);
</script>
</body>
</html>
