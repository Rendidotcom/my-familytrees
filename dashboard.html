<script>
// =======================
// URL Google Apps Script FINAL
// =======================
const API_URL = "https://script.google.com/macros/s/AKfycbzRvMj-bFP08nZMXK1rEnAX7ZvOd46OK-r1bZ4ugT-2rV8vs9VpI1G_APZMJ-3AgBXlRw/exec";

// Convert link Google Drive jadi gambar langsung
function convertDriveURL(url) {
  if (!url) return "https://via.placeholder.com/70";
  if (url.includes("drive.google.com")) {
    const id = url.match(/\/d\/(.*?)\//)?.[1];
    return id ? `https://drive.google.com/uc?export=view&id=${id}` : url;
  }
  return url;
}

// =======================
// LOAD DATA
// =======================
async function loadData() {
  const list = document.getElementById("list");
  list.innerHTML = "Memuat data...";

  try {
    // panggil GAS mode=getData
    const res = await fetch(API_URL + "?mode=getData");
    const json = await res.json();

    if (json.status !== "success") {
      list.innerHTML = `<div class="empty">Gagal memuat data: ${json.message}</div>`;
      return;
    }

    const data = json.data || [];

    if (!data.length) {
      list.innerHTML = `<div class="empty">Belum ada data</div>`;
      return;
    }

    // map UUID ‚Üí object
    const idMap = {};
    data.forEach(p => idMap[p.id] = p);

    let html = "";
    data.forEach(person => {
      const photo = convertDriveURL(person.photoURL);
      const ayah = idMap[person.parentIdAyah]?.name || "-";
      const ibu = idMap[person.parentIdIbu]?.name || "-";
      const pasangan = idMap[person.spouseId]?.name || "-";
      const anak = data
        .filter(p => p.parentIdAyah == person.id || p.parentIdIbu == person.id)
        .map(p => p.name)
        .join(", ") || "-";

      html += `
        <div class="member">
          <img src="${photo}" alt="${person.name}">
          <div class="member-info">
            <h4>${person.name}</h4>
            <p>${person.relationship} ‚Ä¢ ${person.domisili}</p>
            <p><b>Ayah:</b> ${ayah}</p>
            <p><b>Ibu:</b> ${ibu}</p>
            <p><b>Pasangan:</b> ${pasangan}</p>
            <p><b>Anak:</b> ${anak}</p>
          </div>
          <div class="member-buttons">
            <button class="btn-edit" onclick="openEdit('${person.id}')">‚úèÔ∏è Edit</button>
            <button class="btn-del" onclick="deleteMember('${person.id}')">üóëÔ∏è Hapus</button>
          </div>
        </div>
      `;
    });

    list.innerHTML = html;

  } catch (err) {
    console.error("Gagal memuat data:", err);
    list.innerHTML = `<div class="empty">Gagal memuat data</div>`;
  }
}

// =======================
// EDIT & DELETE
// =======================
function openEdit(id) {
  window.location.href = "edit.html?id=" + id;
}

async function deleteMember(id) {
  if (!confirm("Yakin ingin menghapus anggota ini?")) return;

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ mode: "delete", id })
    });
    const json = await res.json();
    alert(json.message || "Berhasil dihapus");
    loadData();
  } catch (err) {
    console.error(err);
    alert("Gagal menghapus data");
  }
}

// =======================
// INIT
// =======================
document.addEventListener("DOMContentLoaded", loadData);
</script>
