<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Dashboard Family Tree 2025</title>

<script>
  const API_URL =
    "https://script.google.com/macros/s/AKfycbxhEHvZQchk6ORKUjmpgwGVpYLbSZ8bYyDF0QgjKruUgz-M_0EMW7pCJ2m5mcuNkwjzXg/exec";
</script>

<style>
body{font-family:Arial,Helvetica,sans-serif;background:#eef1f5;margin:0;padding:0;}
nav{
  position:fixed;top:0;width:100%;
  background:#3498db;padding:12px;
  display:flex;justify-content:space-around;
  color:#fff;font-weight:bold;z-index:100;
}
nav a{color:#fff;text-decoration:none;}
.container{margin-top:80px;padding:15px;}
.card{
  background:#fff;padding:15px;margin-bottom:12px;border-radius:12px;
  box-shadow:0 4px 12px rgba(0,0,0,0.08);
  display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;
}
.card img{
  width:60px;height:60px;border-radius:50%;object-fit:cover;
  border:2px solid #3498db;
}
.card div{width:60%;min-width:150px;}
.card .btn{
  padding:8px;border:none;border-radius:6px;margin-left:5px;cursor:pointer;font-size:14px;
}
.btn-edit{background:#2ecc71;color:#fff;}
.btn-delete{background:#e74c3c;color:#fff;}
.btn-detail{background:#2980b9;color:#fff;}
</style>
</head>

<body>

<nav>
  <a href="dashboard.html">üìã Dashboard</a>
  <span id="addMenu"></span>
  <a href="tree.html">üå≥ Tree</a>
  <a href="#" onclick="logout()">üö™ Logout</a>
</nav>

<div class="container">
  <h2>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Daftar Keluarga</h2>
  <p><b>Login sebagai:</b> <span id="userInfo"></span></p>
  <div id="list">‚è≥ Memuat...</div>
</div>


<script>
// =======================================================
//  AMBIL SESSION LOGIN
// =======================================================
let session = JSON.parse(localStorage.getItem("familyUser") || "null");
if (!session) location.href = "login.html";


// =======================================================
//  VALIDASI TOKEN KE GAS (POST JSON)
// =======================================================
async function validateToken() {
  try {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify({
        action: "validateToken",
        token: session.token
      })
    });

    const j = await res.json();

    if (!j.success) {
      alert("‚ö†Ô∏è Sesi login kadaluarsa. Silakan login ulang.");
      logout();
      return;
    }

    // update session
    session.name = j.name;
    session.role = j.role;
    session.id   = j.id;

    document.getElementById("userInfo").textContent =
      `${session.name} (${session.role})`;

    if (session.role === "admin") {
      document.getElementById("addMenu").innerHTML =
        `<a href="index.html">‚ûï Tambah</a>`;
    }

    loadData();

  } catch (e) {
    alert("‚ùå Kesalahan koneksi saat validasi token.");
    logout();
  }
}

validateToken();


// =======================================================
//  LOAD DATA (POST JSON)
// =======================================================
async function loadData() {
  try {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify({ action: "getData" })
    });

    const j = await res.json();

    if (!j.success || !j.data?.length) {
      document.getElementById("list").innerHTML =
        "‚ö†Ô∏è Tidak ada data keluarga.";
      return;
    }

    let html = "";
    j.data.forEach(p => {
      const photo = p.photoURL || "https://via.placeholder.com/60?text=üë§";

      let buttons = `
        <button class="btn btn-detail" onclick="viewDetail('${p.id}')">
          üëÅ Detail
        </button>
      `;

      if (session.role === "admin" || session.id === p.id) {
        buttons += `
          <button class="btn btn-edit" onclick="editMember('${p.id}')">
            ‚úèÔ∏è Edit
          </button>
        `;
      }

      if (session.role === "admin") {
        buttons += `
          <button class="btn btn-delete" onclick="deleteMember('${p.id}')">
            üóëÔ∏è Hapus
          </button>
        `;
      }

      html += `
        <div class="card">
          <img src="${photo}">
          <div><b>${p.name}</b><br>${p.relationship || ""}</div>
          <div style="min-width:120px;">${buttons}</div>
        </div>
      `;
    });

    document.getElementById("list").innerHTML = html;

  } catch (e) {
    document.getElementById("list").innerHTML =
      "‚ùå Gagal memuat data dari server.";
  }
}


// =======================================================
//  AKSI
// =======================================================
function viewDetail(id) {
  location.href = `detail.html?id=${id}`;
}

function editMember(id) {
  location.href = `edit.html?id=${id}`;
}


// =======================================================
//  DELETE (POST JSON + TOKEN ADMIN)
// =======================================================
async function deleteMember(id) {
  if (!confirm("‚ö†Ô∏è Hapus anggota ini?")) return;

  const res = await fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "text/plain" },
    body: JSON.stringify({
      action: "delete",
      id: id,
      token: session.token
    })
  });

  const j = await res.json();
  if (j.success) {
    alert("üóëÔ∏è Berhasil dihapus.");
    loadData();
  } else {
    alert("‚ùå Gagal: " + (j.message || "Unknown error"));
  }
}


// =======================================================
//  LOGOUT (POST + bersihkan session)
// =======================================================
function logout() {
  fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "text/plain" },
    body: JSON.stringify({ action: "logout", token: session.token })
  }).finally(() => {
    localStorage.removeItem("familyUser");
    location.href = "login.html";
  });
}
</script>

</body>
</html>
