<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>üå≥ Family Tree</title>

<!-- Import endpoint dari config.js -->
<script type="module">
import { API_URL } from "./config.js";
window.API_URL = API_URL;
</script>

<style>
body{
  font-family:Arial,Helvetica,sans-serif;
  background:#eef1f5;
  margin:0;
  padding:0;
  text-align:center;
}
nav{
  background:#3498db;
  padding:12px;
  color:#fff;
  display:flex;
  justify-content:space-around;
  position:sticky;
  top:0;
  font-weight:bold;
}
nav a{color:white;text-decoration:none;}
.tree-container{
  width:96%;
  max-width:1400px;
  margin:25px auto;
  background:white;
  padding:15px;
  border-radius:12px;
  box-shadow:0 5px 16px rgba(0,0,0,0.07);
  overflow-x:auto;
}
.node{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:6px 10px;
  background:#fff;
  border:1px solid #ccc;
  border-radius:12px;
  margin:8px;
  cursor:pointer;
  transition:.25s;
  position:relative;
}
.node:hover{background:#f0f6ff;}
.node img{
  width:55px;
  height:55px;
  border-radius:50%;
  object-fit:cover;
  border:3px solid #ddd;
}
.dead{opacity:0.45;filter:grayscale(1);}
.line{width:2px;background:#999;height:25px;margin:auto;}
.row{display:flex;justify-content:center;flex-wrap:wrap;gap:20px;margin-top:10px;}
.spouse{display:flex;align-items:center;gap:10px;justify-content:center;margin-top:8px;}
.spouse:before{content:"‚ù§Ô∏è";font-size:18px;color:#d63031;}
.hidden-branch{display:none;}
.toggle-btn{font-size:11px;color:#0a84ff;cursor:pointer;margin-top:4px;}
button.filter{
  margin:3px;
  padding:6px 10px;
  border-radius:8px;
  border:none;
  cursor:pointer;
  background:#2980b9;
  color:#fff;
  font-weight:bold;
}
button.filter:hover{background:#1c6395;}
</style>
</head>

<body>

<nav>
  <a href="dashboard.html">üìã Dashboard</a>
  <span id="addBtn"></span>
  <a href="#" onclick="logout()">üö™ Logout</a>
</nav>

<h2 style="margin-top:15px">üå≥ Pohon Keluarga</h2>

<div style="margin:10px;">
  <button class="filter" onclick="renderTree()">üëÄ Semua</button>
  <button class="filter" onclick="renderTree('alive')">üü¢ Hidup</button>
  <button class="filter" onclick="renderTree('dead')">‚ö´ Meninggal</button>
</div>

<div id="tree" class="tree-container">‚è≥ Memuat...</div>

<script>
let session = JSON.parse(localStorage.getItem("familyUser") || "null");
if(!session){ alert("‚ö† Harap login terlebih dahulu!"); location.href="login.html"; }

async function validateToken(){
  try{
    const res = await fetch(`${API_URL}?mode=validate&token=${session.token}`);
    const j = await res.json();
    if(j.status !== "success"){
      alert("üö´ Sesi berakhir, silakan login ulang.");
      logout();
    }else{
      session.role = j.role;
      session.name = j.name;
      if(session.role === "admin"){
        document.getElementById("addBtn").innerHTML = `<a href="index.html">‚ûï Tambah</a>`;
      }
    }
  }catch(err){
    console.error("Token error:", err);
    logout();
  }
}
validateToken();

let members = [];

// ============ HELPERS ============
const getPhoto = url => url ? `https://drive.google.com/uc?export=view&id=${url.match(/[-\\w]{25,}/)?.[0]}` : "https://via.placeholder.com/60";
const findChildren = id => members.filter(m => m.parentIdAyah === id || m.parentIdIbu === id);
const findSpouse = p => members.find(m => m.id === p.spouseId);

// ============ LOAD DATA ============
async function load(){
  try{
    const res = await fetch(`${API_URL}?mode=getData&nocache=${Date.now()}`);
    const j = await res.json();
    if(j.status !== "success") throw new Error(j.message);
    members = j.data || [];
    renderTree();
  }catch(err){
    document.getElementById("tree").innerHTML = "‚ùå Gagal memuat data: " + err.message;
  }
}

// ============ NODE CREATION ============
function createNode(p){
  const div = document.createElement("div");
  div.className = "node " + (p.status === "meninggal" ? "dead" : "");
  div.innerHTML = `
    <img src="${getPhoto(p.photoURL)}" alt="Foto ${p.name}">
    <div style="text-align:left">
      <b>${p.name}</b><br>
      <span style="font-size:12px;color:#666">${p.status==="meninggal"?"‚ö´ Meninggal":"üü¢ Hidup"}</span><br>
      <span class="toggle-btn">Klik untuk buka / detail</span>
    </div>
  `;
  div.onclick = () => location.href = \`detail.html?id=\${p.id}\`;
  return div;
}

// ============ BUILD TREE ============
function buildTree(person, filter){
  const wrapper = document.createElement("div");
  wrapper.style.margin = "20px auto";

  // Node utama
  const node = createNode(person);
  wrapper.appendChild(node);

  // Pasangan
  const spouse = findSpouse(person);
  if(spouse){
    const pair = document.createElement("div");
    pair.className = "spouse";
    pair.append(node, createNode(spouse));
    wrapper.appendChild(pair);
  }

  // Anak-anak
  const kids = findChildren(person.id).filter(k => {
    if(filter === "alive") return k.status !== "meninggal";
    if(filter === "dead") return k.status === "meninggal";
    return true;
  });

  if(kids.length){
    const line = document.createElement("div");
    line.className = "line";
    wrapper.appendChild(line);

    const row = document.createElement("div");
    row.className = "row hidden-branch";
    kids.forEach(k => row.appendChild(buildTree(k, filter)));
    wrapper.appendChild(row);

    node.querySelector(".toggle-btn").onclick = ev => {
      ev.stopPropagation();
      row.style.display = row.style.display === "flex" ? "none" : "flex";
    };
  }

  return wrapper;
}

// ============ RENDER TREE ============
function renderTree(filter="all"){
  const container = document.getElementById("tree");
  container.innerHTML = "";

  const roots = members.filter(m => !m.parentIdAyah && !m.parentIdIbu);
  if(!roots.length){
    container.innerHTML = "<i>Belum ada struktur keluarga.</i>";
    return;
  }

  roots.forEach(r => container.appendChild(buildTree(r, filter)));
}

// ============ LOGOUT ============
function logout(){
  fetch(`${API_URL}?mode=logout&token=${session?.token||""}`)
    .finally(()=>{
      localStorage.removeItem("familyUser");
      location.href="login.html";
    });
}

load();
</script>

</body>
</html>
