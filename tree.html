<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>üå≥ Family Tree</title>

<style>
body{font-family:Arial;background:#eef1f5;margin:0;padding:0;text-align:center}
nav{background:#3498db;padding:12px;color:#fff;display:flex;justify-content:space-around;position:sticky;top:0}
nav a{color:white;text-decoration:none;font-weight:bold}

.tree-container{width:96%;max-width:1200px;margin:25px auto;background:white;padding:15px;
  border-radius:12px;box-shadow:0 5px 16px rgba(0,0,0,0.07);overflow-x:auto}

.node{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;background:#fff;
  border:1px solid #ccc;border-radius:12px;margin:8px;cursor:pointer;
  transition:.25s;position:relative}
.node:hover{background:#f0f6ff}
.node img{width:55px;height:55px;border-radius:50%;object-fit:cover;border:3px solid #ddd}

.dead{opacity:0.45;filter:grayscale(1)}
.line{width:2px;background:#999;height:25px;margin:auto}
.row{display:flex;justify-content:center;flex-wrap:wrap;gap:20px;margin-top:10px}

.spouse{display:flex;align-items:center;gap:10px}
.spouse:before{content:"‚ù§Ô∏è";font-size:20px;color:#d63031}

.hidden-branch{display:none}
.toggle-btn{font-size:11px;color:#0a84ff;cursor:pointer;margin-top:4px}
</style>
</head>
<body>

<nav>
  <a href="dashboard.html">üìã Dashboard</a>
  <span id="addBtn"></span>
  <a href="#" onclick="logout()">üö™ Logout</a>
</nav>

<h2 style="margin-top:15px">üå≥ Family Tree</h2>

<div style="margin:10px">
  <button onclick="renderTree()">üëÄ Semua</button>
  <button onclick="renderTree('alive')">üü¢ Hidup</button>
  <button onclick="renderTree('dead')">‚ö´ Meninggal</button>
</div>

<div id="tree" class="tree-container">‚è≥ Memuat...</div>

<script>
const API_URL="https://script.google.com/macros/s/AKfycby8WX2QXb_mc0lfP6AaAFqRNDIMyRkznr7o16zLU3BG_qwDrxuIHOCbnrlBkw/exec";
const session=JSON.parse(localStorage.getItem("familyUser")||"null");

if(!session){
  alert("‚ö† Harap login terlebih dahulu!");
  location.href="login.html";
}

let members=[];

// ================== VALIDATE TOKEN =====================
async function validateToken(){
  const res = await fetch(`${API_URL}?mode=validateToken&token=${session.token}`);
  const j = await res.json();

  if(!j.valid){
    alert("üö´ Sesi login kedaluwarsa, silakan login ulang.");
    localStorage.removeItem("familyUser");
    location.href="login.html";
  }
}

validateToken();

// ============ SHOW ADD BUTTON ONLY FOR ADMIN ============
document.getElementById("addBtn").innerHTML = 
  session.role === "admin" ? `<a href="index.html">‚ûï Tambah</a>` : "";

// ================== DATA HELPERS =======================

const getPhoto=url=>url?`https://drive.google.com/uc?export=view&id=${url.match(/[-\w]{25,}/)?.[0]}`:"https://via.placeholder.com/60";
const findChildren=(id)=>members.filter(x=>x.parentIdAyah===id||x.parentIdIbu===id);
const findSpouse=(p)=>members.find(x=>x.id===p.spouseId);

async function load(){
  try{
    const res=await fetch(`${API_URL}?mode=getData&nocache=${Date.now()}`);
    const j=await res.json();
    members=j.data||[];
    renderTree();
  }catch(err){
    document.getElementById("tree").innerHTML="‚ùå Error: "+err.message;
  }
}

// ================== BUILD UI NODE ======================

function createNode(p){
  const div=document.createElement("div");
  div.className="node "+(p.status==="meninggal"?"dead":"");

  div.innerHTML=`
    <img src="${getPhoto(p.photoURL)}">
    <div style="text-align:left">
      <b>${p.name}</b><br>
      <span style="font-size:12px;color:#666">
        ${p.status==="meninggal"?"‚ö´ Meninggal":"üü¢ Hidup"}
      </span><br>
      <span class="toggle-btn">Klik untuk buka / detail</span>
    </div>
  `;

  // === ROLE CONTROL: admin bisa edit, user biasa hanya melihat ===
  div.onclick=()=>{
    if(session.role === "admin"){
      location.href = `detail.html?id=${p.id}`;
    } else {
      // User biasa tidak boleh edit ‚Üí hanya lihat profil
      location.href = `detail.html?id=${p.id}&view=readonly`;
    }
  };
  
  return div;
}

// ================= TREE GENERATOR ======================

function buildTree(person,filter){
  const wrapper=document.createElement("div");
  wrapper.style.margin="20px auto";

  let node=createNode(person);
  wrapper.appendChild(node);

  const spouse=findSpouse(person);
  if(spouse){
    const box=document.createElement("div");
    box.className="spouse";
    box.append(node);
    box.append(createNode(spouse));
    wrapper.append(box);
  }

  const kids=findChildren(person.id);
  const filteredKids=kids.filter(k=>{
    if(filter==="alive") return k.status!=="meninggal";
    if(filter==="dead") return k.status==="meninggal";
    return true;
  });

  if(filteredKids.length){
    wrapper.appendChild(document.createElement("div")).className="line";

    const row=document.createElement("div");
    row.className="row hidden-branch";

    filteredKids.forEach(k=>row.appendChild(buildTree(k,filter)));
    wrapper.appendChild(row);

    node.querySelector(".toggle-btn").onclick=(ev)=>{
      ev.stopPropagation();
      row.style.display=row.style.display==="flex"?"none":"flex";
    };
  }

  return wrapper;
}

// ================== RENDER TREE ========================

function renderTree(filter="all"){
  const container=document.getElementById("tree");
  container.innerHTML="";

  const roots=members.filter(p=>!p.parentIdAyah && !p.parentIdIbu);

  if(roots.length===0){
    container.innerHTML="<i>Belum ada struktur keluarga.</i>";
    return;
  }

  roots.forEach(r=>container.appendChild(buildTree(r,filter)));
}


// ================== LOGOUT ========================

function logout(){
  localStorage.removeItem("familyUser");
  location.href="login.html";
}

load();
</script>
</body>
</html>
