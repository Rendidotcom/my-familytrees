<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>üå≥ Pohon Keluarga Terhubung</title>
<style>
body {
  font-family: 'Arial', sans-serif;
  background: #f5f8fa;
  margin: 0;
  text-align: center;
}
h2 {
  background: #4A90E2;
  color: white;
  padding: 15px;
  border-bottom: 3px solid #357ABD;
}
#tree {
  margin: 20px auto;
  display: flex;
  flex-direction: column;
  align-items: center;
  width: fit-content;
}

/* node anggota */
.member {
  display: inline-block;
  padding: 8px 16px;
  border-radius: 18px;
  margin: 6px;
  min-width: 120px;
  text-align: center;
  color: #fff;
  font-weight: bold;
  position: relative;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  cursor: pointer;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.member:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 10px rgba(0,0,0,0.25);
}
.member.alive { background:#2ecc71; }      /* hijau hidup */
.member.deceased { background:#95a5a6; }   /* abu meninggal */

/* tombol status */
.status-btn {
  display: block;
  margin-top: 5px;
  background: rgba(255,255,255,0.2);
  border: none;
  color: #fff;
  padding: 3px 6px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 10px;
}
.status-btn:hover { background: rgba(255,255,255,0.4); }

/* pasangan */
.couple {
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  margin: 10px 0;
}
.couple::before {
  content:"";
  position:absolute;
  width:60px;
  height:2px;
  background:#4A90E2;
  left:50%;
  transform:translateX(-50%);
}
.couple .member { margin:0 40px; }

/* garis ke anak */
.children {
  margin-top: 10px;
  position: relative;
}
.children::before {
  content:"";
  position:absolute;
  top:0;
  left:50%;
  width:2px;
  height:20px;
  background:#4A90E2;
  transform:translateX(-50%);
}
.arrow-down {
  width:0;height:0;
  border-left:6px solid transparent;
  border-right:6px solid transparent;
  border-top:8px solid #4A90E2;
  margin:4px auto;
}
.child-group {
  display:flex;
  justify-content:center;
  flex-wrap:wrap;
  gap:20px;
}
#debug {
  margin:20px auto;
  background:#111;
  color:#0f0;
  font-size:12px;
  padding:8px;
  border-radius:8px;
  max-width:90%;
  max-height:150px;
  overflow:auto;
  text-align:left;
}
.btn {
  background:#27ae60;
  color:white;
  padding:10px 20px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  margin:10px;
}
.btn:hover { background:#1e874b; }
</style>
</head>
<body>

<h2>üå≥ Pohon Keluarga Terhubung</h2>
<div id="tree">Memuat data...</div>
<button class="btn" onclick="window.location.href='dashboard.html'">üè† Dashboard</button>
<div id="debug">üìú Log tampil di sini...</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyjR22fuPOGgHsyVHtic0_TGlkG5StwSAQx5JMVaApl5iQYRjFIbvsKKMpcMR7MlWuT5w/exec";
let members = [];
const visited = new Set();

function log(msg){
  console.log(msg);
  const box=document.getElementById("debug");
  box.innerHTML += "<div>‚û°Ô∏è "+msg+"</div>";
  box.scrollTop = box.scrollHeight;
}

// =========================================
// MUAT DATA DARI GAS
// =========================================
async function loadTree(){
  try{
    const res = await fetch(API_URL + "?mode=getData");
    const json = await res.json();
    if(json.status!=="success") throw new Error(json.message);
    members = json.data || [];
    log("‚úÖ Total anggota: "+members.length);
    renderTree();
  }catch(err){
    document.getElementById("tree").innerHTML="‚ùå Gagal memuat data.";
    log("‚ùå "+err.message);
  }
}

// =========================================
// RENDER STRUKTUR POHON TANPA DUPLIKASI
// =========================================
function renderTree(){
  const tree=document.getElementById("tree");
  tree.innerHTML="";

  // Cari akar yang tidak punya parent
  const roots=members.filter(m=>!m.parentIdAyah && !m.parentIdIbu);
  if(roots.length===0){tree.innerHTML="‚ö†Ô∏è Tidak ditemukan akar keluarga.";return;}

  const rootContainer=document.createElement("div");
  roots.forEach(root=>{
    drawFamily(rootContainer, root);
  });
  tree.appendChild(rootContainer);
}

// =========================================
// GAMBARKAN KELUARGA REKURSIF
// =========================================
function drawFamily(container, person){
  if(!person || visited.has(person.id)) return;
  visited.add(person.id);

  const spouses = members.filter(m => m.spouseId === person.id || person.spouseId === m.id);
  const coupleDiv = document.createElement("div");
  coupleDiv.className="couple";

  coupleDiv.appendChild(createMemberNode(person));
  spouses.forEach(sp=>coupleDiv.appendChild(createMemberNode(sp)));
  container.appendChild(coupleDiv);

  // ambil semua anak yang lahir dari pasangan ini
  const parentIds = [person.id, ...spouses.map(s=>s.id)];
  const children = members.filter(m =>
    parentIds.includes(m.parentIdAyah) || parentIds.includes(m.parentIdIbu)
  );

  if(children.length>0){
    const childrenDiv=document.createElement("div");
    childrenDiv.className="children";
    childrenDiv.innerHTML='<div class="arrow-down"></div>';
    const group=document.createElement("div");
    group.className="child-group";

    children.forEach(ch=>{
      const sub=document.createElement("div");
      drawFamily(sub, ch);
      group.appendChild(sub);
    });

    childrenDiv.appendChild(group);
    container.appendChild(childrenDiv);
  }
}

// =========================================
// NODE INDIVIDU DENGAN STATUS DAN TOGGLE
// =========================================
function createMemberNode(person){
  const div=document.createElement("div");
  const isDead = person.notes && person.notes.toLowerCase().includes("meninggal");
  div.className="member "+(isDead?"deceased":"alive");
  div.innerHTML=`${person.name}<br><small>${person.relationship}</small>`;

  // klik untuk buka detail
  div.onclick=()=>window.location.href=`detail.html?id=${person.id}`;

  // tombol hidup/meninggal
  const btn=document.createElement("button");
  btn.className="status-btn";
  btn.textContent=isDead?"‚ò†Ô∏è Sudah Meninggal":"üíö Masih Hidup";
  btn.onclick=(e)=>{
    e.stopPropagation();
    toggleStatus(person, div, btn);
  };
  div.appendChild(btn);

  return div;
}

// =========================================
// UPDATE STATUS KE GAS
// =========================================
async function toggleStatus(person, div, btn){
  const nowDead = !(person.notes && person.notes.toLowerCase().includes("meninggal"));
  const newNotes = nowDead ? "Meninggal" : "";
  btn.textContent = nowDead ? "‚ò†Ô∏è Sudah Meninggal" : "üíö Masih Hidup";
  div.className = "member " + (nowDead ? "deceased" : "alive");
  person.notes = newNotes;

  // kirim update ke GAS
  try{
    const payload={
      mode:"update",
      id:person.id,
      name:person.name,
      domisili:person.domisili,
      relationship:person.relationship,
      notes:newNotes,
      parentIdAyah:person.parentIdAyah,
      parentIdIbu:person.parentIdIbu,
      spouseId:person.spouseId
    };
    const res=await fetch(API_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(payload)
    });
    const json=await res.json();
    if(json.status!=="success") throw new Error(json.message);
    log(`‚úÖ Status ${person.name} diperbarui: ${newNotes || "Hidup"}`);
  }catch(err){
    log("‚ùå toggleStatus error: "+err.message);
    alert("Gagal menyimpan status: "+err.message);
  }
}

document.addEventListener("DOMContentLoaded",loadTree);
</script>

</body>
</html>
