<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pohon Keluarga v7.6</title>
  <script src="https://balkan.app/js/familytree.js"></script>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f4f6f9;
    }

    .header {
      background: #4287f5;
      padding: 15px;
      text-align: center;
      color: white;
      font-size: 22px;
      font-weight: bold;
    }

    #tree {
      width: 100%;
      height: calc(100vh - 70px);
    }

    .alive img {
      filter: none;
    }
    .dead img {
      filter: grayscale(100%);
      opacity: 0.7;
    }
  </style>
</head>

<body>
  <div class="header">ðŸŒ³ Pohon Keluarga v7.6 â€“ Family Node Layout</div>
  <div id="tree"></div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzRvMj-bFP08nZMXK1rEnAX7ZvOd46OK-r1bZ4ugT-2rV8vs9VpI1G_APZMJ-3AgBXlRw/exec";

// ===============================
// Load data
// ===============================
async function loadFamily() {
  const res = await fetch(API_URL + "?mode=getData&v=" + Date.now());
  const json = await res.json();
  const rows = json.data || [];

  // Deduplicate â€” merge same names
  const merged = {};
  const nameMap = {};

  rows.forEach(r => {
    const n = r.name.trim();
    if (!merged[n]) {
      merged[n] = {
        name: n,
        idPrimary: r.id,
        ids: [r.id],
        domisili: r.domisili,
        relationship: r.relationship,
        notes: r.notes,
        photoURL: r.photoURL,
        parents: new Set(),
        spouses: new Set()
      };
    } else {
      merged[n].ids.push(r.id);
    }

    if (r.parentIdAyah) merged[n].parents.add(r.parentIdAyah);
    if (r.parentIdIbu) merged[n].parents.add(r.parentIdIbu);

    if (r.spouseId) {
      String(r.spouseId)
        .split(/[,;|]/)
        .map(x => x.trim())
        .filter(x => x)
        .forEach(x => merged[n].spouses.add(x));
    }

    nameMap[r.id] = n;
  });

  console.log("Merged data:", merged);
  return { merged, nameMap };
}

// ===============================
// Build tree nodes
// ===============================
function buildNodes(merged, nameMap) {
  const nodes = [];

  // Build data
  Object.keys(merged).forEach(name => {
    const m = merged[name];
    const nodeId = "N_" + m.idPrimary;

    const isDead = checkStatus(m.notes);

    nodes.push({
      id: nodeId,
      name: m.name,
      photo: convertPhoto(m.photoURL),
      class: isDead ? "dead" : "alive"
    });
  });

  // Add relationships
  Object.keys(merged).forEach(name => {
    const m = merged[name];
    const childId = "N_" + m.idPrimary;

    // Parents
    m.parents.forEach(pid => {
      const pname = nameMap[pid];
      if (pname && merged[pname]) {
        nodes.push({
          id: childId,
          pid: "N_" + merged[pname].idPrimary
        });
      }
    });

    // Spouses
    m.spouses.forEach(sid => {
      const sname = nameMap[sid];
      if (sname && merged[sname]) {
        nodes.push({
          id: childId,
          spouse: "N_" + merged[sname].idPrimary
        });
      }
    });
  });

  return nodes;
}

// ===============================
// Helpers
// ===============================
function convertPhoto(url) {
  if (!url) return "https://static.thenounproject.com/png/363640-200.png";
  const idMatch = url.match(/\/d\/([^\/]+)/);
  if (idMatch) return `https://drive.google.com/uc?export=view&id=${idMatch[1]}`;
  return url;
}

function checkStatus(notes) {
  if (!notes) return false;
  const m = notes.toLowerCase();
  return m.includes("dead") || m.includes("meninggal");
}

// ===============================
// Render FamilyTree
// ===============================
function renderTree(nodes) {
  window.family = new FamilyTree(document.getElementById("tree"), {
    nodes,
    template: "luba",
    nodeBinding: {
      field_0: "name",
      img_0: "photo"
    },
    nodeSeparation: 60,
    levelSeparation: 120,
  });
}

// ===============================
// INIT
// ===============================
async function init() {
  const { merged, nameMap } = await loadFamily();
  const nodes = buildNodes(merged, nameMap);
  renderTree(nodes);
}

init();
</script>
</body>
</html>
