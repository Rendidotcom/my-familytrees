<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>üå≥ Pohon Keluarga</title>
<style>
body {
  font-family: 'Arial', sans-serif;
  background: #f5f8fa;
  margin: 0;
  text-align: center;
}
h2 {
  background: #4A90E2;
  color: white;
  padding: 15px;
  border-bottom: 3px solid #357ABD;
}
#tree {
  margin-top: 30px;
  display: flex;
  flex-direction: column;
  align-items: center;
}
.member {
  background: #fff;
  border: 2px solid #4A90E2;
  border-radius: 20px;
  padding: 10px 18px;
  margin: 10px;
  min-width: 120px;
  text-align: center;
  box-shadow: 0 3px 8px rgba(0,0,0,0.1);
  position: relative;
}
.member::after {
  content: "";
  position: absolute;
  left: 50%;
  bottom: -20px;
  width: 2px;
  height: 20px;
  background: #4A90E2;
  transform: translateX(-50%);
}
.level {
  display: flex;
  flex-direction: column;
  align-items: center;
  position: relative;
}
.connector {
  width: 2px;
  background: #4A90E2;
  height: 20px;
}
.arrow-down {
  width: 0; 
  height: 0; 
  border-left: 6px solid transparent;
  border-right: 6px solid transparent;
  border-top: 8px solid #4A90E2;
  margin: 4px 0;
}
#debug {
  margin: 20px auto;
  background: #111;
  color: #0f0;
  font-size: 12px;
  padding: 8px;
  border-radius: 8px;
  max-width: 90%;
  max-height: 150px;
  overflow: auto;
  text-align: left;
}
.btn {
  background: #27ae60;
  color: white;
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  margin: 10px;
}
.btn:hover { background: #1e874b; }
</style>
</head>
<body>

<h2>üå≥ Pohon Keluarga</h2>
<div id="tree">Memuat data...</div>
<button class="btn" onclick="window.location.href='dashboard.html'">üè† Kembali ke Dashboard</button>
<div id="debug">üìú Log tampil di sini...</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyjR22fuPOGgHsyVHtic0_TGlkG5StwSAQx5JMVaApl5iQYRjFIbvsKKMpcMR7MlWuT5w/exec";
let members = [];

function log(msg){
  console.log(msg);
  const box=document.getElementById("debug");
  box.innerHTML += "<div>‚û°Ô∏è "+msg+"</div>";
  box.scrollTop = box.scrollHeight;
}

// ==============================
// MUAT DATA DARI GAS
// ==============================
async function loadTree(){
  try {
    log("üîÅ Fetching data from GAS...");
    const res = await fetch(API_URL + "?mode=getData");
    const json = await res.json();
    if(json.status !== "success") throw new Error(json.message);
    members = json.data || [];
    log("‚úÖ Total anggota: "+members.length);
    buildTree();
  } catch(err){
    log("‚ùå loadTree error: "+err.message);
    document.getElementById("tree").innerHTML = "‚ùå Gagal memuat data.";
  }
}

// ==============================
// BANGUN POHON KELUARGA
// ==============================
function buildTree(){
  const container = document.getElementById("tree");
  container.innerHTML = "";

  // Temukan generasi paling atas (tidak punya parent)
  const rootMembers = members.filter(m => !m.parentIdAyah && !m.parentIdIbu);
  if(rootMembers.length === 0){
    container.innerHTML = "‚ö†Ô∏è Tidak ditemukan akar keluarga.";
    return;
  }

  rootMembers.forEach(root => {
    const level = document.createElement("div");
    level.className = "level";
    addMemberNode(level, root);
    buildChildren(level, root.id, 1);
    container.appendChild(level);
  });
}

// ==============================
// REKURSIF: BANGUN ANAK TURUNAN
// ==============================
function buildChildren(parentDiv, parentId, depth){
  const children = members.filter(m => m.parentIdAyah === parentId || m.parentIdIbu === parentId);
  if(children.length === 0) return;

  const connector = document.createElement("div");
  connector.className = "connector";
  parentDiv.appendChild(connector);

  const arrow = document.createElement("div");
  arrow.className = "arrow-down";
  parentDiv.appendChild(arrow);

  children.forEach(child => {
    const childLevel = document.createElement("div");
    childLevel.className = "level";
    addMemberNode(childLevel, child);
    buildChildren(childLevel, child.id, depth + 1);
    parentDiv.appendChild(childLevel);
  });
}

// ==============================
// BUAT NODE ANGGOTA
// ==============================
function addMemberNode(container, member){
  const div = document.createElement("div");
  div.className = "member";
  div.innerHTML = `<b>${member.name}</b><br><small>${member.relationship}</small>`;
  container.appendChild(div);
}

document.addEventListener("DOMContentLoaded", loadTree);
</script>

</body>
</html>
