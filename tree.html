<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>üå≥ Pohon Keluarga v7.5 ‚Äì Family Node Layout</title>
<style>
body { font-family: Arial, sans-serif; margin:0; background:#f5f8fa; text-align:center; }
h2 { background:#4A90E2; color:white; padding:15px; border-bottom:3px solid #357ABD; }
#controls { margin:10px 0; }
.btn { background:#27ae60; color:white; padding:8px 14px; border:none; border-radius:8px; cursor:pointer; margin:4px; }
.btn:hover { background:#1e874b; }
#tree-wrapper { width:100%; height:80vh; overflow:auto; border:1px solid #ccc; background:#fff; }
.node rect { stroke:#357ABD; stroke-width:2px; cursor:pointer; }
.node text { fill:#fff; font-weight:bold; pointer-events:none; }
.node.alive rect { fill:#2ecc71; }
.node.deceased rect { fill:#95a5a6; }
.link { fill:none; stroke:#4A90E2; stroke-width:2px; }
.status-btn { margin-top:2px; font-size:10px; cursor:pointer; padding:2px 4px; border-radius:6px; border:none; background:rgba(255,255,255,0.2); color:#fff; }
.status-btn:hover { background:rgba(255,255,255,0.4); }
#debug { margin:10px auto; background:#111; color:#0f0; font-size:12px; padding:6px; border-radius:8px; max-width:90%; max-height:100px; overflow:auto; text-align:left; }
</style>
</head>
<body>

<h2>üå≥ Pohon Keluarga v7.5 ‚Äì Family Node Layout</h2>

<div id="controls">
  <button class="btn" onclick="zoomIn()">‚ûï Zoom In</button>
  <button class="btn" onclick="zoomOut()">‚ûñ Zoom Out</button>
  <button class="btn" onclick="resetZoom()">üîÑ Reset</button>
  <button class="btn" onclick="window.location.href='dashboard.html'">üè† Dashboard</button>
</div>

<div id="tree-wrapper">
  <svg id="tree" width="2000" height="2000"></svg>
</div>
<div id="debug">üìú Log tampil di sini...</div>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyjR22fuPOGgHsyVHtic0_TGlkG5StwSAQx5JMVaApl5iQYRjFIbvsKKMpcMR7MlWuT5w/exec";
let members = [];
let zoom = d3.zoom().scaleExtent([0.3, 3]);

function log(msg){
  console.log(msg);
  const box=document.getElementById("debug");
  box.innerHTML += "<div>‚û°Ô∏è "+msg+"</div>";
  box.scrollTop = box.scrollHeight;
}

function zoomIn(){
  svg.transition().call(zoom.scaleBy, 1.2);
}
function zoomOut(){
  svg.transition().call(zoom.scaleBy, 0.8);
}
function resetZoom(){
  svg.transition().call(zoom.scaleTo, 1);
}

// ===== Load Data =====
async function loadTree(){
  try{
    const res = await fetch(API_URL+"?mode=getData");
    const json = await res.json();
    if(json.status!=="success") throw new Error(json.message);
    members = json.data || [];
    log("‚úÖ Total anggota: "+members.length);
    buildFamilyTree();
  }catch(err){
    log("‚ùå "+err.message);
  }
}

// ===== SVG Setup =====
const svg = d3.select("#tree");
const g = svg.append("g");
svg.call(zoom.on("zoom", (event)=>{g.attr("transform", event.transform);}))

// ===== Build Family Tree Hierarchy =====
function buildFamilyTree(){
  g.selectAll("*").remove();

  // map members by id
  const map = {};
  members.forEach(m=>map[m.id]=m);

  // create family nodes
  const families = [];
  const used = new Set();
  members.forEach(p=>{
    if(used.has(p.id)) return;
    const spouses = members.filter(s=>s.id===p.spouseId || s.spouseId===p.id);
    let family = {id:"fam_"+p.id, parents:[p], children:[]};
    spouses.forEach(s=>{
      if(!used.has(s.id)){
        family.parents.push(s);
        used.add(s.id);
      }
    });
    families.push(family);
    used.add(p.id);
  });

  // attach children
  families.forEach(f=>{
    f.children = members.filter(m =>
      f.parents.some(par => par.id===m.parentIdAyah || par.id===m.parentIdIbu)
    );
  });

  // convert to hierarchy for d3
  function createHierarchy(family){
    return {
      name: family.parents.map(p=>p.name).join(" & "),
      family,
      children: family.children.map(c=>{
        // find family node where child is parent
        const childFam = families.find(fam => fam.parents.some(par=>par.id===c.id));
        return childFam ? createHierarchy(childFam) : {name:c.name, person:c};
      })
    }
  }

  const roots = families.filter(f => !f.parents.some(p=>p.parentIdAyah || p.parentIdIbu));
  if(roots.length===0){ log("‚ö†Ô∏è Tidak ada akar keluarga"); return; }

  const rootHierarchy = {name:"Keluarga", children:roots.map(f=>createHierarchy(f))};
  const treeLayout = d3.tree().nodeSize([180, 120]);
  const root = d3.hierarchy(rootHierarchy);
  treeLayout(root);

  // links
  g.selectAll(".link")
    .data(root.links())
    .join("path")
    .attr("class","link")
    .attr("d", d3.linkVertical().x(d=>d.x).y(d=>d.y));

  // nodes
  const node = g.selectAll(".node")
    .data(root.descendants())
    .join("g")
    .attr("class",d=>"node")
    .attr("transform",d=>`translate(${d.x},${d.y})`);

  node.each(function(d){
    if(d.data.family){
      d.data.family.parents.forEach((p,i)=>{
        const gnode = d3.select(this).append("g").attr("transform",`translate(${i*140 - 70},0)`);
        gnode.append("rect").attr("width",120).attr("height",40).attr("x",-60).attr("y",-20)
          .attr("class",p.notes && p.notes.toLowerCase().includes("meninggal") ? "deceased":"alive");
        gnode.append("text").attr("text-anchor","middle").attr("dy","5").text(p.name);
        const btn = d3.select(this).append("foreignObject")
          .attr("x",-50).attr("y",20).attr("width",100).attr("height",20)
          .html(`<button class="status-btn">${p.notes && p.notes.toLowerCase().includes("meninggal")?"‚ò†Ô∏è Sudah Meninggal":"üíö Masih Hidup"}</button>`);
      });
    } else if(d.data.person){
      const p = d.data.person;
      d3.select(this).append("rect").attr("width",120).attr("height",40).attr("x",-60).attr("y",-20)
        .attr("class",p.notes && p.notes.toLowerCase().includes("meninggal")?"deceased":"alive");
      d3.select(this).append("text").attr("text-anchor","middle").attr("dy","5").text(p.name);
    }
  });
}

document.addEventListener("DOMContentLoaded", loadTree);
</script>

</body>
</html>
