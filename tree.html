<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ğŸŒ³ Family Tree</title>
<style>
body{font-family:Arial;background:#eef1f5;margin:0;padding:0;text-align:center}
nav{background:#3498db;padding:12px;color:#fff;display:flex;justify-content:space-around;position:sticky;top:0}
nav a{color:white;text-decoration:none;font-weight:bold}
.tree-container{width:96%;max-width:1200px;margin:25px auto;background:white;padding:15px;border-radius:12px;box-shadow:0 5px 16px rgba(0,0,0,0.07);overflow-x:auto}
.node{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;background:#fff;border:1px solid #ccc;border-radius:12px;margin:8px;cursor:pointer;transition:.25s;position:relative}
.node:hover{background:#f0f6ff}
.node img{width:55px;height:55px;border-radius:50%;object-fit:cover;border:3px solid #ddd}
.dead{opacity:0.45;filter:grayscale(1)}
.line{width:2px;background:#999;height:25px;margin:auto}
.row{display:flex;justify-content:center;flex-wrap:wrap;gap:20px;margin-top:10px}
.spouse{display:flex;align-items:center;gap:10px}
.spouse:before{content:"â¤ï¸";font-size:20px;color:#d63031}
.hidden-branch{display:none}
.toggle-btn{font-size:11px;color:#0a84ff;cursor:pointer;margin-top:4px}
</style>
</head>
<body>

<nav>
  <a href="dashboard.html">ğŸ“‹ Dashboard</a>
  <span id="addBtn"></span>
  <a href="#" onclick="logout()">ğŸšª Logout</a>
</nav>

<h2 style="margin-top:15px">ğŸŒ³ Family Tree</h2>

<div style="margin:10px">
  <button onclick="renderTree()">ğŸ‘€ Semua</button>
  <button onclick="renderTree('alive')">ğŸŸ¢ Hidup</button>
  <button onclick="renderTree('dead')">âš« Meninggal</button>
</div>

<div id="tree" class="tree-container">â³ Memuat...</div>

<script>
const API_URL="https://script.google.com/macros/s/AKfycby8WX2QXb_mc0lfP6AaAFqRNDIMyRkznr7o16zLU3BG9wV39uBG_qwDrxuIHOCbnrlBkw/exec";
const session=JSON.parse(localStorage.getItem("familyUser")||"null");

if(!session){ alert("âš  Harap login!"); location.href="login.html"; }

async function validateToken(){
  try{
    const res=await fetch(`${API_URL}?mode=validate&token=${session.token}`);
    const j=await res.json();
    if(j.status!=="success"){ alert("ğŸš« Sesi habis, login ulang."); logout(); }
  }catch(e){ console.error(e); logout(); }
}
validateToken();

// Admin menu
document.getElementById("addBtn").innerHTML = session.role==="admin" ? `<a href="index.html">â• Tambah</a>` : "";

let members=[];

// ===== Helpers =====
const getPhoto=url=>url?`https://drive.google.com/uc?export=view&id=${url.match(/[-\w]{25,}/)?.[0]}`:"https://via.placeholder.com/60";
const findChildren=id=>members.filter(x=>x.parentIdAyah===id||x.parentIdIbu===id);
const findSpouse=p=>members.find(x=>x.id===p.spouseId);

// ===== Load Members =====
async function load(){
  try{
    const res=await fetch(`${API_URL}?mode=getData&nocache=${Date.now()}`);
    const j=await res.json();
    members=j.data||[];
    renderTree();
  }catch(err){ document.getElementById("tree").innerHTML="âŒ Error: "+err.message; }
}

// ===== Build Node =====
function createNode(p){
  const div=document.createElement("div");
  div.className="node "+(p.status==="meninggal"?"dead":"");
  div.innerHTML=`
    <img src="${getPhoto(p.photoURL)}">
    <div style="text-align:left">
      <b>${p.name}</b><br>
      <span style="font-size:12px;color:#666">${p.status==="meninggal"?"âš« Meninggal":"ğŸŸ¢ Hidup"}</span><br>
      <span class="toggle-btn">Klik untuk buka / detail</span>
    </div>
  `;
  div.onclick=()=>{
    location.href=`detail.html?id=${p.id}`;
  };
  return div;
}

// ===== Build Tree =====
function buildTree(person,filter){
  const wrapper=document.createElement("div");
  wrapper.style.margin="20px auto";

  let node=createNode(person);
  wrapper.appendChild(node);

  const spouse=findSpouse(person);
  if(spouse){
    const box=document.createElement("div");
    box.className="spouse";
    box.append(node, createNode(spouse));
    wrapper.appendChild(box);
  }

  const kids=findChildren(person.id).filter(k=>{
    if(filter==="alive") return k.status!=="meninggal";
    if(filter==="dead") return k.status==="meninggal";
    return true;
  });

  if(kids.length){
    const line=document.createElement("div"); line.className="line"; wrapper.appendChild(line);

    const row=document.createElement("div");
    row.className="row hidden-branch";
    kids.forEach(k=>row.appendChild(buildTree(k,filter)));
    wrapper.appendChild(row);

    node.querySelector(".toggle-btn").onclick=(ev)=>{
      ev.stopPropagation();
      row.style.display=row.style.display==="flex"?"none":"flex";
    };
  }

  return wrapper;
}

// ===== Render Tree =====
function renderTree(filter="all"){
  const container=document.getElementById("tree");
  container.innerHTML="";
  const roots=members.filter(p=>!p.parentIdAyah && !p.parentIdIbu);
  if(roots.length===0){ container.innerHTML="<i>Belum ada struktur keluarga.</i>"; return; }
  roots.forEach(r=>container.appendChild(buildTree(r,filter)));
}

// ===== Logout =====
function logout(){ localStorage.removeItem("familyUser"); location.href="login.html"; }

load();
</script>

</body>
</html>
