<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>ğŸŒ³ Pohon Keluarga v7.0 â€“ Smart Graph</title>
<style>
body {
  margin: 0;
  overflow: hidden;
  background: #f5f8fa;
  font-family: Arial, sans-serif;
}
header {
  background: #4A90E2;
  color: white;
  padding: 10px 15px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
header h2 { margin: 0; font-size: 18px; }
.controls button {
  background: #2ecc71;
  color: white;
  border: none;
  border-radius: 6px;
  margin-left: 5px;
  padding: 6px 12px;
  cursor: pointer;
}
.controls button:hover { background: #27ae60; }
#tree-container {
  width: 100vw;
  height: calc(100vh - 50px);
  overflow: hidden;
  position: relative;
}
svg {
  width: 100%;
  height: 100%;
  background: #f9fcff;
  cursor: grab;
}
.node {
  cursor: pointer;
}
text {
  font-size: 12px;
  text-anchor: middle;
  font-weight: bold;
}
.alive circle { fill: #2ecc71; }
.deceased circle { fill: #95a5a6; }
line {
  stroke: #4A90E2;
  stroke-width: 2;
}
</style>
</head>
<body>

<header>
  <h2>ğŸŒ³ Pohon Keluarga v7.0</h2>
  <div class="controls">
    <button onclick="resetView()">ğŸ”„ Reset</button>
    <button onclick="zoomIn()">â•</button>
    <button onclick="zoomOut()">â–</button>
    <button onclick="window.location='dashboard.html'">ğŸ  Dashboard</button>
  </div>
</header>

<div id="tree-container">
  <svg id="tree"></svg>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyjR22fuPOGgHsyVHtic0_TGlkG5StwSAQx5JMVaApl5iQYRjFIbvsKKMpcMR7MlWuT5w/exec";
let members = [];
let visited = new Set();

// =======================
// LAYOUT STATE
// =======================
let scale = 1;
let offsetX = 0;
let offsetY = 0;
let isPanning = false;
let startX, startY;

// =======================
// FETCH DATA
// =======================
async function loadData() {
  const res = await fetch(API_URL + "?mode=getData");
  const json = await res.json();
  if (json.status === "success") {
    members = json.data;
    renderTree();
  } else {
    alert("Gagal memuat data");
  }
}

// =======================
// BUILD GRAPH STRUCTURE
// =======================
function buildGraph() {
  const map = new Map();
  members.forEach(m => map.set(m.id, {...m, children: []}));

  for (const m of map.values()) {
    if (m.parentIdAyah && map.has(m.parentIdAyah)) map.get(m.parentIdAyah).children.push(m);
    if (m.parentIdIbu && map.has(m.parentIdIbu)) map.get(m.parentIdIbu).children.push(m);
  }

  // akar: tanpa ayah/ibu
  return Array.from(map.values()).filter(m => !m.parentIdAyah && !m.parentIdIbu);
}

// =======================
// LAYOUT POSITIONS
// =======================
function layout(node, depth = 0, x = 0) {
  const spacingY = 120;
  const spacingX = 160;
  node.x = x;
  node.y = depth * spacingY;
  let width = 0;

  if (node.children && node.children.length > 0) {
    const childPositions = [];
    node.children.forEach((child, i) => {
      const cw = layout(child, depth + 1, x + width);
      childPositions.push(child.x);
      width += cw + spacingX;
    });
    node.x = (Math.min(...childPositions) + Math.max(...childPositions)) / 2;
  }

  return width || 160;
}

// =======================
// RENDER SVG TREE
// =======================
function renderTree() {
  const svg = document.getElementById("tree");
  svg.innerHTML = "";

  const roots = buildGraph();
  let x = 0;
  roots.forEach(r => {
    layout(r, 0, x);
    x += 300;
  });

  const allNodes = [];
  function traverse(node) {
    allNodes.push(node);
    node.children.forEach(traverse);
  }
  roots.forEach(traverse);

  // gambar garis
  allNodes.forEach(node => {
    node.children.forEach(child => {
      const line = document.createElementNS("http://www.w3.org/2000/svg","line");
      line.setAttribute("x1", node.x);
      line.setAttribute("y1", node.y);
      line.setAttribute("x2", child.x);
      line.setAttribute("y2", child.y);
      svg.appendChild(line);
    });
  });

  // gambar node
  allNodes.forEach(node => {
    const g = document.createElementNS("http://www.w3.org/2000/svg","g");
    g.classList.add("node", node.notes?.toLowerCase().includes("meninggal") ? "deceased" : "alive");
    g.setAttribute("transform", `translate(${node.x},${node.y})`);
    g.addEventListener("click", () => window.location=`detail.html?id=${node.id}`);

    const circle = document.createElementNS("http://www.w3.org/2000/svg","circle");
    circle.setAttribute("r", "25");

    const text = document.createElementNS("http://www.w3.org/2000/svg","text");
    text.setAttribute("y", "40");
    text.textContent = node.name;

    g.appendChild(circle);
    g.appendChild(text);
    svg.appendChild(g);
  });

  updateView();
}

// =======================
// ZOOM & PAN HANDLERS
// =======================
const svg = document.getElementById("tree-container");
svg.addEventListener("mousedown", e => {
  isPanning = true;
  startX = e.clientX - offsetX;
  startY = e.clientY - offsetY;
});
svg.addEventListener("mouseup", () => isPanning = false);
svg.addEventListener("mousemove", e => {
  if (isPanning) {
    offsetX = e.clientX - startX;
    offsetY = e.clientY - startY;
    updateView();
  }
});
svg.addEventListener("wheel", e => {
  e.preventDefault();
  if (e.deltaY < 0) zoomIn(); else zoomOut();
});

function zoomIn() { scale *= 1.1; updateView(); }
function zoomOut() { scale *= 0.9; updateView(); }
function resetView() { scale = 1; offsetX = 0; offsetY = 0; updateView(); }

function updateView() {
  const tree = document.getElementById("tree");
  tree.setAttribute("transform", `translate(${offsetX},${offsetY}) scale(${scale})`);
}

// =======================
document.addEventListener("DOMContentLoaded", loadData);
</script>

</body>
</html>
