<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Family Tree</title>
<style>
body { margin:0; font-family:Arial; background:#f4f7fa; }
#tree-container { width:100%; height:100vh; }
.node rect {
  stroke:#555; fill:#fff; stroke-width:1.5px; rx:6; ry:6;
}
.node text {
  font:12px sans-serif;
  pointer-events:none;
}
.link {
  fill:none;
  stroke:#555;
  stroke-width:1.5px;
}
.node.alive rect { fill:#2ecc71; }
.node.dead rect { fill:#95a5a6; }
</style>
</head>
<body>

<div id="tree-container"></div>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
// =====================================
// Konfigurasi
// =====================================
const API_URL = "https://script.google.com/macros/s/AKfycbzRg74Zyz9ox0gy0se3CS_QWWzkzmJyUk2524KO6C0zAARDO1f5pj4w75dXAr8RoP7LzA/exec";

// =====================================
// Utility: convert flat data ke tree
// =====================================
function buildTree(data) {
    const nodes = {};
    const roots = [];

    // Buat node unik
    data.forEach(d => {
        nodes[d.id] = { ...d, children: [], spouses: [] };
        if (!d.status) nodes[d.id].status = "alive"; // default hidup
    });

    // Hubungkan anak ke orang tua
    data.forEach(d => {
        if (d.parentIdAyah && nodes[d.parentIdAyah]) nodes[d.parentIdAyah].children.push(nodes[d.id]);
        if (d.parentIdIbu && nodes[d.parentIdIbu]) nodes[d.parentIdIbu].children.push(nodes[d.id]);
        if (!d.parentIdAyah && !d.parentIdIbu) roots.push(nodes[d.id]);
    });

    // Hubungkan pasangan
    data.forEach(d => {
        if (d.spouseId && nodes[d.spouseId]) {
            nodes[d.id].spouses.push(nodes[d.spouseId]);
        }
    });

    return roots;
}

// =====================================
// Render tree dengan D3
// =====================================
async function renderTree() {
    const res = await fetch(API_URL+"?mode=getData");
    const json = await res.json();
    if(json.status !== "success") return alert("Gagal memuat data tree");

    const data = json.data;

    const roots = buildTree(data);

    const width = document.body.clientWidth;
    const height = document.body.clientHeight;

    const svg = d3.select("#tree-container")
        .append("svg")
        .attr("width", width)
        .attr("height", height)
        .call(d3.zoom().scaleExtent([0.1,2]).on("zoom", (event) => {
            g.attr("transform", event.transform);
        }))
        .append("g");

    const g = svg.append("g");

    const treeLayout = d3.tree().nodeSize([120, 120]);
    
    // Untuk banyak root, buat group horizontal
    roots.forEach((rootNode, i) => {
        const root = d3.hierarchy(rootNode, d => d.children);
        treeLayout(root);

        // Links
        g.selectAll(".link"+i)
            .data(root.links())
            .enter()
            .append("path")
            .attr("class","link")
            .attr("d", d3.linkVertical()
                .x(d=>d.x)
                .y(d=>d.y));

        // Node
        const node = g.selectAll(".node"+i)
            .data(root.descendants())
            .enter()
            .append("g")
            .attr("class", d => "node "+(d.data.status==="alive"?"alive":"dead"))
            .attr("transform", d => `translate(${d.x},${d.y})`);

        node.append("rect")
            .attr("width", 100)
            .attr("height", 40)
            .attr("x", -50)
            .attr("y", -20)
            .attr("rx",6)
            .attr("ry",6);

        node.append("text")
            .attr("dy", 5)
            .attr("text-anchor","middle")
            .text(d => d.data.name);
    });

    // Tambah garis pasangan
    data.forEach(d => {
        if(d.spouseId && data.find(s=>s.id===d.spouseId)){
            const spouse = data.find(s=>s.id===d.spouseId);
            const x1 = d3.select(`.node`).filter(n=>n.data.id===d.id).attr("transform").match(/translate\(([^,]+),([^\)]+)\)/);
            const x2 = d3.select(`.node`).filter(n=>n.data.id===spouse.id).attr("transform").match(/translate\(([^,]+),([^\)]+)\)/);
            if(x1 && x2){
                g.append("line")
                    .attr("class","link")
                    .attr("stroke-dasharray","4,2")
                    .attr("x1", +x1[1])
                    .attr("y1", +x1[2])
                    .attr("x2", +x2[1])
                    .attr("y2", +x2[2]);
            }
        }
    });
}

renderTree();
</script>

</body>
</html>
