<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Login Family Tree</title>

<style>
body{font-family:Arial;background:#dff3ff;height:100vh;display:flex;justify-content:center;align-items:center;margin:0}
.container{background:#fff;width:90%;max-width:380px;padding:25px;border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,0.08);}
h2{text-align:center;margin-bottom:20px}
input{width:100%;padding:12px;margin-top:12px;border:1px solid #bbb;border-radius:8px;font-size:16px;}
button{width:100%;padding:12px;margin-top:18px;border:none;color:white;font-size:16px;background:#4A90E2;border-radius:8px;cursor:pointer;}
.message{margin-top:15px;font-size:14px;text-align:center;}
.error{color:red;}
.success{color:green;}
</style>
</head>

<body>
<div class="container">
  <h2>üîê Login Family Tree</h2>

  <input type="text" id="nameInput" placeholder="Nama lengkap" autocomplete="name"/>

  <button onclick="checkUser()">Lanjut</button>

  <div id="pinForm" style="display:none;">
      <p id="pinCaption"></p>
      <input type="password" id="pin1" placeholder="PIN 4 digit" maxlength="4">
      <input type="password" id="pin2" placeholder="Ulangi PIN" maxlength="4" style="display:none;">
      <button onclick="submitPin()">Masuk</button>
  </div>

  <p id="msg" class="message"></p>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycby8WX2QXb_mc0lfP6AaAFqRNDIMyRkznr7o16zLU3BG9wV39uBG_qwDrxuIHOCbnrlBkw/exec";

let userRecord = null;

async function checkUser(){
  const name = document.getElementById("nameInput").value.trim();
  const msg = document.getElementById("msg");

  if(!name){ msg.textContent="‚ö† Masukkan nama"; msg.className="error"; return; }
  msg.textContent="‚è≥ Mencari..."; msg.className="";

  try {
    const res = await fetch(`${API_URL}?mode=getUsers&nocache=${Date.now()}`);
    const json = await res.json();

    if(json.status!=="success"){
      msg.textContent="‚ùå Gagal ambil data"; msg.className="error";
      return;
    }

    userRecord = json.data.find(u => u.name.toLowerCase() === name.toLowerCase());

    if(!userRecord){
      msg.textContent="‚ùå Nama tidak ditemukan"; msg.className="error";
      return;
    }

    msg.innerHTML = `üëã Halo <b>${userRecord.name}</b>`; 
    msg.className="success";
    document.getElementById("pinForm").style.display="block";

    if(userRecord.pinHash){
        document.getElementById("pinCaption").innerText="Masukkan PIN untuk login:";
        document.getElementById("pin2").style.display="none";
    } else {
        document.getElementById("pinCaption").innerText="Buat PIN baru (pertama kali login):";
        document.getElementById("pin2").style.display="block";
    }

  } catch(err){
    msg.textContent="‚ùå Koneksi error"; msg.className="error";
  }
}

async function submitPin(){
  const msg = document.getElementById("msg");
  const pin1 = document.getElementById("pin1").value.trim();
  const pin2 = document.getElementById("pin2").value.trim();

  if(!userRecord) return;

  if(!userRecord.pinHash && pin1 !== pin2){
    msg.textContent="‚ùå PIN tidak sama"; msg.className="error";
    return;
  }

  msg.textContent="üîê Verifikasi..."; msg.className="";

  try {
    const payload = {
      mode: "login",
      id: userRecord.id,
      pin: pin1
    };

    const response = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify(payload)
    });

    const data = await response.json();

    if(data.status !== "success"){
        msg.textContent = "‚ùå " + data.message;
        msg.className = "error";
        return;
    }

    msg.textContent = "‚úî Login berhasil!";
    msg.className = "success";

    // Simpan session + token
    const session = {
      id: userRecord.id,
      name: userRecord.name,
      role: data.role,
      token: data.token,
      tokenExpire: Date.now() + (1000 * 60 * 60 * 24) // 24 jam
    };

    localStorage.setItem("familyUser", JSON.stringify(session));

    setTimeout(()=>{
      if(data.role === "admin") window.location.href = "admin.html";
      else window.location.href = "dashboard.html";
    },800);

  } catch(err){
    msg.textContent="‚ùå Koneksi error"; msg.className="error";
  }
}

window.onload = ()=>{
  const session = JSON.parse(localStorage.getItem("familyUser") || "null");
  if(session && session.token && session.tokenExpire > Date.now()){
      window.location.href = session.role==="admin" ? "admin.html" : "dashboard.html";
  }
};
</script>
</body>
</html>
