<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Login Family Tree</title>

<style>
body { 
  font-family: Arial; 
  display: flex; 
  justify-content: center; 
  align-items: center; 
  height: 100vh; 
  background:#eef2f5;
}

.box {
  background:white; 
  padding:30px; 
  border-radius:12px; 
  width:320px; 
  box-shadow:0 3px 12px rgba(0,0,0,0.1);
}

input, button {
  width:100%;
  padding:12px;
  border-radius:8px;
  border:1px solid #ccc;
  margin-top:12px;
}

button { 
  background:#4a90e2; 
  color:white; 
  border:none; 
  cursor:pointer;
  font-weight:bold;
}

#errorMsg {
  color:red;
  font-size:14px;
  margin-top:10px;
}
#successMsg {
  color:green;
  font-size:14px;
  margin-top:10px;
}

.hidden {
  display:none;
}
</style>
</head>

<body>

<div class="box">
  <h3>üîê Masuk Family Tree</h3>

  <!-- Step 1: Cari Nama atau UUID -->
  <input id="loginField" placeholder="Nama lengkap atau ID (UUID)">
  <button onclick="checkUser()">Lanjut</button>

  <!-- Step 2: Input PIN -->
  <div id="pinSection" class="hidden">
    <input id="pinInput" placeholder="Masukkan PIN" type="password" maxlength="6">
    <button onclick="verifyPIN()">Masuk</button>
  </div>

  <!-- Step 3: Buat PIN Baru -->
  <div id="createPINSection" class="hidden">
    <p><b>Buat PIN pertama untuk akun ini:</b></p>
    <input id="newPinInput" placeholder="PIN baru" type="password" maxlength="6">
    <input id="confirmPinInput" placeholder="Konfirmasi PIN" type="password" maxlength="6">
    <button onclick="setNewPIN()">Simpan PIN & Login</button>
  </div>

  <p id="errorMsg"></p>
  <p id="successMsg"></p>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzRg74Zyz9ox0gy0se3CS_QWWzkzmJyUk2524KO6C0zAARDO1f5pj4w75dXAr8RoP7LzA/exec";

let selectedUser = null;

// ============================
// STEP 1 ‚Üí Cek User
// ============================
async function checkUser() {
  const input = document.getElementById("loginField").value.trim().toLowerCase();
  const msg = document.getElementById("errorMsg");
  const ok = document.getElementById("successMsg");

  msg.textContent = "";
  ok.textContent = "";

  if (!input) {
    msg.textContent = "‚ö† Masukkan nama atau ID!";
    return;
  }

  try {
    const res = await fetch(`${API_URL}?mode=getData`);
    const json = await res.json();
    const users = json.data || [];

    selectedUser = users.find(u => 
      u.name?.toLowerCase() === input || String(u.id).toLowerCase() === input
    );

    if (!selectedUser) {
      msg.textContent = "‚ùå Nama atau ID tidak ditemukan!";
      return;
    }

    // Cek apakah sudah punya PIN
    if (selectedUser.pinSet) {
      ok.textContent = `‚úî Ditemukan: ${selectedUser.name}. Silakan masukkan PIN.`;
      document.getElementById("pinSection").classList.remove("hidden");
    } else {
      ok.textContent = `üëã Halo, ${selectedUser.name}! Buat PIN pertama kamu.`;
      document.getElementById("createPINSection").classList.remove("hidden");
    }

  } catch (err) {
    msg.textContent = "‚ùå Gagal koneksi server.";
  }
}

// ============================
// STEP 2 ‚Üí Masukkan PIN
// ============================
async function verifyPIN() {
  const pin = document.getElementById("pinInput").value.trim();
  const msg = document.getElementById("errorMsg");
  const ok = document.getElementById("successMsg");

  if (!pin) {
    msg.textContent = "‚ö† PIN wajib diisi!";
    return;
  }

  const res = await fetch(`${API_URL}?mode=login&id=${selectedUser.id}&pin=${pin}`);
  const json = await res.json();

  if (json.status === "success") {
    ok.textContent = "‚úî Login berhasil!";
    loginToApp();
  } else {
    msg.textContent = "‚ùå PIN salah!";
  }
}

// ============================
// STEP 3 ‚Üí Buat PIN pertama
// ============================
async function setNewPIN() {
  const pin1 = document.getElementById("newPinInput").value.trim();
  const pin2 = document.getElementById("confirmPinInput").value.trim();
  const msg = document.getElementById("errorMsg");
  const ok = document.getElementById("successMsg");

  if (!pin1 || !pin2) return msg.textContent = "‚ö† Semua kolom PIN harus diisi!";
  if (pin1 !== pin2) return msg.textContent = "‚ùå PIN tidak sama!";
  if (pin1.length < 4) return msg.textContent = "‚ö† Minimal 4 digit PIN!";

  const res = await fetch(`${API_URL}?mode=login&id=${selectedUser.id}&pin=${pin1}`);
  const json = await res.json();

  if (json.success) {
    ok.textContent = "‚úî PIN berhasil dibuat!";
    loginToApp();
  } else {
    msg.textContent = "‚ùå Gagal menyimpan PIN.";
  }
}

// ============================
// SIMPAN SESSION
// ============================
function loginToApp() {
  localStorage.setItem("activeUser", selectedUser.id);
  localStorage.setItem("activeUserName", selectedUser.name);

  setTimeout(() => {
    window.location.href = "tree.html";
  }, 800);
}
</script>
</body>
</html>
