/**************************************************************
 ðŸŒ³ FAMILY DASHBOARD GAS FINAL + LOGIN + INSERT FIX (2025-11)
**************************************************************/

const SPREADSHEET_ID = "1HgeAi_jN-oDBa4W4RuzXPEml_672E0mC1d9S_Fn-Cgo"; 
const SHEET_NAME = "Sheet1";
const DRIVE_FOLDER_ID = "1ZHjicuBHrei0WbdminvAxjaYsKJ0HQ9m";

// ===================== UTILITY =====================
function allowCors(output) {
  return output
    .setMimeType(ContentService.MimeType.JSON)
    .setHeader("Access-Control-Allow-Origin", "*")
    .setHeader("Access-Control-Allow-Methods", "GET, POST, OPTIONS");
}

function hashPIN(pin) {
  return Utilities.computeDigest(Utilities.DigestAlgorithm.SHA_256, pin)
  .map(b => ('0' + (b & 0xFF).toString(16)).slice(-2))
  .join('');
}

function findRowById(id, sheet) {
  const values = sheet.getRange(2, 10, sheet.getLastRow() - 1, 1).getValues();
  for (let i = 0; i < values.length; i++) {
    if (String(values[i][0]) === String(id)) return i + 2;
  }
  return -1;
}

function createResponse(obj, callback=null) {
  const json = JSON.stringify(obj);
  let output = ContentService.createTextOutput(callback ? `${callback}(${json})` : json);
  return allowCors(output);
}


// ===================== ROUTER =====================
function doGet(e) {
  const mode = e?.parameter?.mode || "";

  try {
    switch (mode) {
      case "getData": return doGetData();
      case "delete": return handleDelete(e.parameter.id);
      case "login": return loginUser(e.parameter.id, e.parameter.pin);
      case "resetpin": return resetPin(e.parameter.id, e.parameter.pin);
      default: return createResponse({ status: "ok", message: "API Online" });
    }
  } catch (err) {
    return createResponse({ status: "error", message: err.message });
  }
}

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const mode = data.mode || "";

    switch (mode) {
      case "insert": return insertData(data);
      case "update": return updateData(data);
      case "delete": return handleDelete(data.id);

      // FIX: supaya index.html bisa kirim request dengan payload
      case "proxyUpdate": return insertData(JSON.parse(data.payload));

      default:
        return createResponse({ status: "error", message: "Mode tidak dikenali" });
    }

  } catch (err) {
    return createResponse({ status: "error", message: err.message });
  }
}



// ===================== LOGIN =====================
function loginUser(id, pin) {
  const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(SHEET_NAME);
  const row = findRowById(id, sheet);

  if (row === -1) return createResponse({ status: "error", message: "User tidak ditemukan" });

  const storedHash = sheet.getRange(row, 13).getValue();

  if (!storedHash) {
    sheet.getRange(row, 13).setValue(hashPIN(pin));
    return createResponse({ status: "success", firstTime: true, login: true });
  }

  return createResponse(storedHash === hashPIN(pin)
    ? { status: "success", login: true }
    : { status: "error", message: "PIN salah!" }
  );
}
function resetPin(id, newPin) {
  const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(SHEET_NAME);
  const row = findRowById(id, sheet);
  if (row === -1) return createResponse({ status: "error", message: "User tidak ditemukan" });

  const newHash = hashPIN(newPin);
  sheet.getRange(row, 13).setValue(newHash);

  return createResponse({ status: "success", message: "PIN berhasil diperbarui" });
}



// ===================== CREATE =====================
function insertData(data) {
  const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(SHEET_NAME);
  const folder = DriveApp.getFolderById(DRIVE_FOLDER_ID);
  const newId = Utilities.getUuid();
  
  let photoURL = "";
  if (data.photo_base64) {
    const blob = Utilities.newBlob(Utilities.base64Decode(data.photo_base64), data.photo_type, `${newId}.jpg`);
    const file = folder.createFile(blob);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    photoURL = file.getUrl();
  }

  sheet.appendRow([
    new Date(), data.name, data.domisili, data.relationship, photoURL,
    data.notes, data.parentIdAyah, data.parentIdIbu, data.spouseId,
    newId, data.orderChild || "", data.status || "", ""
  ]);

  return createResponse({ status: "success", id: newId });
}



// ===================== UPDATE =====================
function updateData(data) {
  const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(SHEET_NAME);
  const folder = DriveApp.getFolderById(DRIVE_FOLDER_ID);
  const row = findRowById(data.id, sheet);

  if (row === -1) return createResponse({ status: "error", message: "ID tidak ditemukan" });

  let photoURL = sheet.getRange(row, 5).getValue();

  if (data.photo_base64) {
    const blob = Utilities.newBlob(Utilities.base64Decode(data.photo_base64), data.photo_type, `${data.id}.jpg`);
    const file = folder.createFile(blob);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    photoURL = file.getUrl();
  }

  sheet.getRange(row, 2, 1, 11).setValues([[
    data.name, data.domisili, data.relationship,
    photoURL, data.notes, data.parentIdAyah, data.parentIdIbu,
    data.spouseId, data.id, data.orderChild || "", data.status || ""
  ]]);

  return createResponse({ status: "success", id: data.id });
}



// ===================== GET ALL =====================
function doGetData() {
  const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(SHEET_NAME);
  const values = sheet.getDataRange().getValues();

  const data = values.slice(1).map(r => ({
    timestamp: r[0], name: r[1], domisili: r[2], relationship: r[3],
    photoURL: r[4], notes: r[5], parentIdAyah: r[6], parentIdIbu: r[7],
    spouseId: r[8], id: r[9], orderChild: r[10], status: r[11], pinSet: !!r[12]
  }));

  return createResponse({ status: "success", data });
}



// ===================== DELETE =====================
function handleDelete(id) {
  const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(SHEET_NAME);
  const row = findRowById(id, sheet);

  if (row === -1) return createResponse({ status: "error", message: "ID tidak ditemukan" });

  sheet.deleteRow(row);
  return createResponse({ status: "success", id });
}
